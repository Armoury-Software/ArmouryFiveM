(()=>{"use strict";const e={onAccountAuthenticate:"authentication:account-success",onPlayerConnect:"playerJoining",onPlayerDeath:"armoury:onPlayerDeath",onPlayerAuthenticate:"authentication:player-authenticated",onPlayerDisconnect:"playerDropped",onResourceStop:"onResourceStop",onContextMenuItemPressed:"armoury-overlay:context-menu-item-pressed",onPlayerEnterVehicle:"armoury:onPlayerEnterVehicle",onPlayerExitVehicle:"armoury:onPlayerExitVehicle",onPlayerClientsidedCacheLoaded:"armoury:player-resource-cache-loaded"};var t;!function(e){e[e.SERVER_TO_SERVER=0]="SERVER_TO_SERVER",e[e.SERVER_TO_CLIENT=1]="SERVER_TO_CLIENT",e[e.CLIENT_TO_SERVER=2]="CLIENT_TO_SERVER",e[e.CLIENT_TO_CLIENT=3]="CLIENT_TO_CLIENT"}(t||(t={}));const n=new Map,i=new Map,r=new Map;function s(e){return function(s){return class extends s{constructor(...o){super(...o),this.translationFile=null==e?void 0:e.translationFile,n.has(s)&&n.get(s).forEach((([e,n,i])=>{i===t.CLIENT_TO_CLIENT?on(n,super[e].bind(this)):onNet(n,super[e].bind(this))})),i.has(s)&&i.get(s).forEach((e=>{exports(e,super[e].bind(this))})),r.has(s)&&r.get(s).forEach((([e,t])=>{IsDuplicityVersion()?RegisterCommand(e.toLowerCase(),((n,i,r)=>{Number(global.exports.authentication.getPlayerInfo(n,"adminLevel"))<t||super[e].call(this,n,i,r)}),!1):RegisterCommand(e.toLowerCase(),((t,n,i)=>{super[e].call(this,n,i)}),!1)}))}}}}function o(i){return function(r,s,o){const a=e[s]||(null==i?void 0:i.eventName),l=(null==i?void 0:i.direction)||t.CLIENT_TO_SERVER;(null==a?void 0:a.length)?(n.has(r.constructor)||n.set(r.constructor,[]),n.get(r.constructor).some((([e,t,n])=>e===s))||n.get(r.constructor).push([s,a,l])):console.error(`${s} is not recognized as a default event, thus this listener won't work. Please use the eventName property inside the data parameter.`)}}function a(){return function(e,t,n){i.has(e.constructor)||i.set(e.constructor,[]),i.get(e.constructor).some((e=>e===t))||i.get(e.constructor).push(t)}}const l=e=>!/^\s*$/.test(e)&&(e=(e=(e=e.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@")).replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]")).replace(/(?:^|:|,)(?:\s*\[)+/g,""),/^[\],:{}\s]*$/.test(e));var c=function(e,t,n,i){var r,s=arguments.length,o=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(o=(s<3?r(o):s>3?r(t,n,o):r(t,n))||o);return s>3&&o&&Object.defineProperty(t,n,o),o};let u=class extends class{constructor(){this.routingBucketCondition=(e,t)=>!0,this.assignServerBaseListeners()}RegisterAdminCommand(e,t,n,i){RegisterCommand(e,((e,i,r)=>{Number(global.exports.authentication.getPlayerInfo(e,"adminLevel"))<t||n(e,i,r)}),i)}assignServerBaseListeners(){onNet(`${GetCurrentResourceName()}:set-client-routing-bucket`,((e,t)=>{this.routingBucketCondition(e,t)&&SetEntityRoutingBucket(e,t)}))}setRoutingBucket(e,t){SetEntityRoutingBucket(GetPlayerPed(e),t),TriggerClientEvent(`${GetCurrentResourceName()}:set-routing-bucket`,e,t)}}{constructor(){super(...arguments),this._virtualWorldsWithPlayers=new Map}get virtualWorldsWithPlayers(){return this._virtualWorldsWithPlayers}onPlayerEnteredScope(e){TriggerClientEvent(`${GetCurrentResourceName()}:refresh-virtual-world`,e.for)}setPlayerVirtualWorld(e,t){const n=this.getPlayerVirtualWorld(e);isNaN(n)||this._virtualWorldsWithPlayers.set(n,(this._virtualWorldsWithPlayers.has(n)?this._virtualWorldsWithPlayers.get(n):[]).filter((t=>t!==e)));const i=[...this._virtualWorldsWithPlayers.has(t)?this._virtualWorldsWithPlayers.get(t):[],e];this._virtualWorldsWithPlayers.set(t,i),global.exports.authentication.setPlayerInfo(e,"virtualWorld",t)}getPlayerVirtualWorld(e){return Math.max(0,Number(global.exports.authentication.getPlayerInfo(e,"virtualWorld")))}removeClientsideVehicles(){TriggerClientEvent(`${GetCurrentResourceName()}:ARM_remove-vehicles`,-1)}};c([o({eventName:"playerEnteredScope"})],u.prototype,"onPlayerEnteredScope",null),u=c([s()],u);var d=function(e,t,n,i){var r,s=arguments.length,o=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(o=(s<3?r(o):s>3?r(t,n,o):r(t,n))||o);return s>3&&o&&Object.defineProperty(t,n,o),o};let h=class extends u{constructor(){super(...arguments),this._translationLanguage="ro",this._clientsidedResourceMap=new Map}get translationLanguage(){return this._translationLanguage}get clientsidedResourceMap(){return this._clientsidedResourceMap}getPlayerClientsidedCacheKey(e,t){if(this._clientsidedResourceMap.has(e)){const n=this._clientsidedResourceMap.get(e);if(n[t])return n[t]}return null}updatePlayerClientsidedCacheKey(e,t,n){const i=this._clientsidedResourceMap.has(e)&&this._clientsidedResourceMap.get(e)||{};i[t]=n,this._clientsidedResourceMap.set(e,i),TriggerClientEvent("armoury-overlay:update-resource-metadata",e,GetCurrentResourceName(),t,n)}onPlayerClientsidedCacheLoaded(e){e[GetCurrentResourceName()]&&this._clientsidedResourceMap.set(source,e[GetCurrentResourceName()])}onPlayerDisconnect(){this._clientsidedResourceMap.has(source)&&this._clientsidedResourceMap.delete(source)}translate(e,t){let n=this.translationFile[this._translationLanguage][e];return t&&Object.keys(t).forEach((e=>{n=n.replace(`{${e}}`,t[e])})),n}setTranslationLanguage(e){this._translationLanguage=e}};d([o()],h.prototype,"onPlayerClientsidedCacheLoaded",null),d([o()],h.prototype,"onPlayerDisconnect",null),h=d([s()],h);var y=function(e,t,n,i){var r,s=arguments.length,o=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(o=(s<3?r(o):s>3?r(t,n,o):r(t,n))||o);return s>3&&o&&Object.defineProperty(t,n,o),o},p=function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function a(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}l((i=i.apply(e,t||[])).next())}))};let g=class extends h{constructor(e,t=!1){super(),this.dbTableName=e,this._entities=[],this._cachedProperties=[],this._playerToEntityBindings=new Map,this.computeTableProperties(),t&&this.loadDBEntities()}get entities(){return this._entities}get cachedProperties(){return this._cachedProperties}get playerToEntityBindings(){return this._playerToEntityBindings}getEntities(){return this._entities}createEntity(e,t){return(()=>p(this,void 0,void 0,(function*(){try{let n=this.getEntityProperties(e),i=this.getEntityPropertiesValues(e,n);t&&(n=["id",...n],i=[t.toString(),...i]);const r=yield global.exports.oxmysql.insert_async(`INSERT INTO \`${this.dbTableName}\` (${n.join(", ")}) VALUES (${Array(n.length).fill("?").join(", ")})`,i),s=Object.assign(Object.assign({},e),{id:t||r});return this._entities.push(s),this.syncWithClients(),s}catch(e){return console.log(e),null}})))()}removeEntity(e){return(()=>p(this,void 0,void 0,(function*(){try{const t=yield global.exports.oxmysql.query_async(`DELETE FROM \`${this.dbTableName}\` WHERE id = ?`,[e.id]);return this._entities=this._entities.filter((t=>t.id!==e.id)),this.syncWithClients(),!!t}catch(e){return console.log(e),!1}})))()}saveDBEntityAsync(e){return(()=>p(this,void 0,void 0,(function*(){try{const t=this.getEntityByDBId(e),n=this.getEntityProperties(t),i=this.getEntityPropertiesValues(t,n),r=" = ?, ",s=yield global.exports.oxmysql.update_async(`UPDATE \`${this.dbTableName}\` SET ${n.join(r).concat(r).slice(0,-2)} WHERE id = ?`,[...i,t.id]);return s&&this.syncWithClients(),s>0}catch(e){return console.log(e),!1}})))()}getEntityByDBId(e){return this._entities.find((t=>t.id===e))}loadDBEntityFor(e,t="id",n){return p(this,void 0,void 0,(function*(){const i=(yield global.exports.oxmysql.query_async(`SELECT * FROM \`${this.dbTableName}\` WHERE ${t} = ?`,[e])).map((e=>(Object.keys(e).forEach((t=>{e[t]=JSON.parse(l(e[t].toString())?e[t]:`"${e[t]}"`,(function(e,t){return"object"==typeof t||isNaN(t)?t:Number(t)}))})),e)));return(null==i?void 0:i.length)?(i.forEach((e=>{this._entities.push(e),n&&this.bindEntityToPlayerByEntityId(e.id,n)})),setTimeout((()=>{this.syncWithClients()}),2e3),(null==i?void 0:i.length)>1?i:i[0]):null}))}loadDBEntities(){return p(this,void 0,void 0,(function*(){const e=(yield global.exports.oxmysql.query_async(`SELECT * FROM \`${this.dbTableName}\``,[])).map((e=>(Object.keys(e).forEach((t=>{e[t]=JSON.parse(l(e[t].toString())?e[t]:`"${e[t]}"`,(function(e,t){return"object"==typeof t||isNaN(t)?t:Number(t)}))})),e)));return(null==e?void 0:e.length)&&(this._entities=e,setTimeout((()=>{this.syncWithClients()}),2e3)),this._entities}))}getEntityProperties(e){const t=[];for(let n in e)"id"===n||this._cachedProperties.length&&!this._cachedProperties.includes(n)||t.push(n);return t}getEntityPropertiesValues(e,t){return t.map((t=>Array.isArray(e[t])||"object"==typeof e[t]?JSON.stringify(e[t]):e[t].toString()))}syncWithClients(e){TriggerClientEvent(`${GetCurrentResourceName()}:db-send-entities`,e||-1,this.entities)}bindEntityToPlayer(e,t){this.entities.includes(e)&&this.bindEntityToPlayerByEntityId(e.id,t)}bindEntityToPlayerByEntityId(e,t){this._entities.some((t=>t.id===e))&&(this._playerToEntityBindings.has(t)?this._playerToEntityBindings.set(t,[...this._playerToEntityBindings.get(t),e]):this._playerToEntityBindings.set(t,[e]))}onBoundEntityDestroyed(e,t){}onPlayerAuthenticate(e,t){this._entities.length&&this.syncWithClients(e)}onPlayerDisconnect(){this._playerToEntityBindings.has(source)&&((this._playerToEntityBindings.has(source)?this._playerToEntityBindings.get(source):[]).forEach((e=>{const t=this._entities.find((t=>t.id===e));t&&(this.onBoundEntityDestroyed(t,source),this._entities.splice(this._entities.indexOf(t),1))})),this._playerToEntityBindings.delete(source))}computeTableProperties(){return p(this,void 0,void 0,(function*(){const e=yield global.exports.oxmysql.query_async(`DESCRIBE ${this.dbTableName}`,[]);e?e.forEach((e=>{this._cachedProperties.push(e.Field)})):console.error(`[SQL ERROR:] computeTableProperties for ${GetCurrentResourceName()} did not work.`)}))}};y([a()],g.prototype,"getEntities",null),y([o()],g.prototype,"onPlayerAuthenticate",null),y([o()],g.prototype,"onPlayerDisconnect",null),g=y([s()],g);var E=function(e,t,n,i){var r,s=arguments.length,o=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(o=(s<3?r(o):s>3?r(t,n,o):r(t,n))||o);return s>3&&o&&Object.defineProperty(t,n,o),o};let f=class extends g{addToFactionLog(e,t){this.createEntity({id:0,timestamp:Date.now(),content:t,factionInternalId:e})}getFactionLogs(e,t=10){return n=this,i=void 0,s=function*(){return(yield global.exports.oxmysql.query_async(`SELECT timestamp, content FROM \`${this.dbTableName}\` WHERE factionInternalId = ? ORDER BY timestamp DESC LIMIT ?`,[e,t])).map((e=>{const t=new Date(e.timestamp),n=new Date,i=t.setHours(0,0,0,0)===n.setHours(0,0,0,0)?this.translate("today"):`${t.getDate()}/${t.getMonth()+1}/${t.getFullYear()%100}`;return Object.assign(Object.assign({},e),{timestamp:i})}))},new((r=void 0)||(r=Promise))((function(e,t){function o(e){try{l(s.next(e))}catch(e){t(e)}}function a(e){try{l(s.throw(e))}catch(e){t(e)}}function l(t){var n;t.done?e(t.value):(n=t.value,n instanceof r?n:new r((function(e){e(n)}))).then(o,a)}l((s=s.apply(n,i||[])).next())}));var n,i,r,s}};E([a()],f.prototype,"addToFactionLog",null),E([a()],f.prototype,"getFactionLogs",null),f=E([s({translationFile:{en:{today:"Today",yesterday:"Yesterday"},ro:{today:"Astazi",yesterday:"Ieri"}}})],f),new f("factions_logs",!1)})();