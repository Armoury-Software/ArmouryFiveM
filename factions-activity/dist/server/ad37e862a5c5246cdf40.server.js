(()=>{"use strict";const t={onAccountAuthenticate:"authentication:account-success",onPlayerConnect:"playerJoining",onPlayerDeath:"armoury:onPlayerDeath",onPlayerAuthenticate:"authentication:player-authenticated",onPlayerDisconnect:"playerDropped",onResourceStop:"onResourceStop",onContextMenuItemPressed:"armoury-overlay:context-menu-item-pressed",onPlayerEnterVehicle:"armoury:onPlayerEnterVehicle",onPlayerExitVehicle:"armoury:onPlayerExitVehicle",onPlayerClientsidedCacheLoaded:"armoury:player-resource-cache-loaded"};var e;!function(t){t[t.SERVER_TO_SERVER=0]="SERVER_TO_SERVER",t[t.SERVER_TO_CLIENT=1]="SERVER_TO_CLIENT",t[t.CLIENT_TO_SERVER=2]="CLIENT_TO_SERVER",t[t.CLIENT_TO_CLIENT=3]="CLIENT_TO_CLIENT"}(e||(e={}));const i=new Map,n=new Map,r=new Map;function s(t){return function(s){return class extends s{constructor(...o){super(...o),this.translationFile=null==t?void 0:t.translationFile,i.has(s)&&i.get(s).forEach((([t,i,n])=>{n===e.CLIENT_TO_CLIENT?on(i,super[t].bind(this)):onNet(i,super[t].bind(this))})),n.has(s)&&n.get(s).forEach((t=>{exports(t,super[t].bind(this))})),r.has(s)&&r.get(s).forEach((([t,e])=>{IsDuplicityVersion()?RegisterCommand(t.toLowerCase(),((i,n,r)=>{Number(global.exports.authentication.getPlayerInfo(i,"adminLevel"))<e||super[t].call(this,i,n,r)}),!1):RegisterCommand(t.toLowerCase(),((e,i,n)=>{super[t].call(this,i,n)}),!1)}))}}}}function o(n){return function(r,s,o){const a=t[s]||(null==n?void 0:n.eventName),l=(null==n?void 0:n.direction)||e.CLIENT_TO_SERVER;(null==a?void 0:a.length)?(i.has(r.constructor)||i.set(r.constructor,[]),i.get(r.constructor).some((([t,e,i])=>t===s))||i.get(r.constructor).push([s,a,l])):console.error(`${s} is not recognized as a default event, thus this listener won't work. Please use the eventName property inside the data parameter.`)}}function a(){return function(t,e,i){n.has(t.constructor)||n.set(t.constructor,[]),n.get(t.constructor).some((t=>t===e))||n.get(t.constructor).push(e)}}const l=t=>!/^\s*$/.test(t)&&(t=(t=(t=t.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@")).replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]")).replace(/(?:^|:|,)(?:\s*\[)+/g,""),/^[\],:{}\s]*$/.test(t));var c=function(t,e,i,n){var r,s=arguments.length,o=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(o=(s<3?r(o):s>3?r(e,i,o):r(e,i))||o);return s>3&&o&&Object.defineProperty(e,i,o),o};let u=class extends class{constructor(){this.routingBucketCondition=(t,e)=>!0,this.assignServerBaseListeners()}RegisterAdminCommand(t,e,i,n){RegisterCommand(t,((t,n,r)=>{Number(global.exports.authentication.getPlayerInfo(t,"adminLevel"))<e||i(t,n,r)}),n)}assignServerBaseListeners(){onNet(`${GetCurrentResourceName()}:set-client-routing-bucket`,((t,e)=>{this.routingBucketCondition(t,e)&&SetEntityRoutingBucket(t,e)}))}setRoutingBucket(t,e){SetEntityRoutingBucket(GetPlayerPed(t),e),TriggerClientEvent(`${GetCurrentResourceName()}:set-routing-bucket`,t,e)}}{constructor(){super(...arguments),this._virtualWorldsWithPlayers=new Map}get virtualWorldsWithPlayers(){return this._virtualWorldsWithPlayers}onPlayerEnteredScope(t){TriggerClientEvent(`${GetCurrentResourceName()}:refresh-virtual-world`,t.for)}setPlayerVirtualWorld(t,e){const i=this.getPlayerVirtualWorld(t);isNaN(i)||this._virtualWorldsWithPlayers.set(i,(this._virtualWorldsWithPlayers.has(i)?this._virtualWorldsWithPlayers.get(i):[]).filter((e=>e!==t)));const n=[...this._virtualWorldsWithPlayers.has(e)?this._virtualWorldsWithPlayers.get(e):[],t];this._virtualWorldsWithPlayers.set(e,n),global.exports.authentication.setPlayerInfo(t,"virtualWorld",e)}getPlayerVirtualWorld(t){return Math.max(0,Number(global.exports.authentication.getPlayerInfo(t,"virtualWorld")))}removeClientsideVehicles(){TriggerClientEvent(`${GetCurrentResourceName()}:ARM_remove-vehicles`,-1)}};c([o({eventName:"playerEnteredScope"})],u.prototype,"onPlayerEnteredScope",null),u=c([s()],u);var y=function(t,e,i,n){var r,s=arguments.length,o=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(o=(s<3?r(o):s>3?r(e,i,o):r(e,i))||o);return s>3&&o&&Object.defineProperty(e,i,o),o};let d=class extends u{constructor(){super(...arguments),this._translationLanguage="ro",this._clientsidedResourceMap=new Map}get translationLanguage(){return this._translationLanguage}get clientsidedResourceMap(){return this._clientsidedResourceMap}getPlayerClientsidedCacheKey(t,e){if(this._clientsidedResourceMap.has(t)){const i=this._clientsidedResourceMap.get(t);if(i[e])return i[e]}return null}updatePlayerClientsidedCacheKey(t,e,i){const n=this._clientsidedResourceMap.has(t)&&this._clientsidedResourceMap.get(t)||{};n[e]=i,this._clientsidedResourceMap.set(t,n),TriggerClientEvent("armoury-overlay:update-resource-metadata",t,GetCurrentResourceName(),e,i)}onPlayerClientsidedCacheLoaded(t){t[GetCurrentResourceName()]&&this._clientsidedResourceMap.set(source,t[GetCurrentResourceName()])}onPlayerDisconnect(){this._clientsidedResourceMap.has(source)&&this._clientsidedResourceMap.delete(source)}translate(t,e){let i=this.translationFile[this._translationLanguage][t];return e&&Object.keys(e).forEach((t=>{i=i.replace(`{${t}}`,e[t])})),i}setTranslationLanguage(t){this._translationLanguage=t}};y([o()],d.prototype,"onPlayerClientsidedCacheLoaded",null),y([o()],d.prototype,"onPlayerDisconnect",null),d=y([s()],d);var h=function(t,e,i,n){var r,s=arguments.length,o=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(o=(s<3?r(o):s>3?r(e,i,o):r(e,i))||o);return s>3&&o&&Object.defineProperty(e,i,o),o},p=function(t,e,i,n){return new(i||(i=Promise))((function(r,s){function o(t){try{l(n.next(t))}catch(t){s(t)}}function a(t){try{l(n.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}l((n=n.apply(t,e||[])).next())}))};let g=class extends d{constructor(t,e=!1){super(),this.dbTableName=t,this._entities=[],this._cachedProperties=[],this._playerToEntityBindings=new Map,this.computeTableProperties(),e&&this.loadDBEntities()}get entities(){return this._entities}get cachedProperties(){return this._cachedProperties}get playerToEntityBindings(){return this._playerToEntityBindings}getEntities(){return this._entities}createEntity(t,e){return(()=>p(this,void 0,void 0,(function*(){try{let i=this.getEntityProperties(t),n=this.getEntityPropertiesValues(t,i);e&&(i=["id",...i],n=[e.toString(),...n]);const r=yield global.exports.oxmysql.insert_async(`INSERT INTO \`${this.dbTableName}\` (${i.join(", ")}) VALUES (${Array(i.length).fill("?").join(", ")})`,n),s=Object.assign(Object.assign({},t),{id:e||r});return this._entities.push(s),this.syncWithClients(),s}catch(t){return console.log(t),null}})))()}removeEntity(t){return(()=>p(this,void 0,void 0,(function*(){try{const e=yield global.exports.oxmysql.query_async(`DELETE FROM \`${this.dbTableName}\` WHERE id = ?`,[t.id]);return this._entities=this._entities.filter((e=>e.id!==t.id)),this.syncWithClients(),!!e}catch(t){return console.log(t),!1}})))()}saveDBEntityAsync(t){return(()=>p(this,void 0,void 0,(function*(){try{const e=this.getEntityByDBId(t),i=this.getEntityProperties(e),n=this.getEntityPropertiesValues(e,i),r=" = ?, ",s=yield global.exports.oxmysql.update_async(`UPDATE \`${this.dbTableName}\` SET ${i.join(r).concat(r).slice(0,-2)} WHERE id = ?`,[...n,e.id]);return s&&this.syncWithClients(),s>0}catch(t){return console.log(t),!1}})))()}getEntityByDBId(t){return this._entities.find((e=>e.id===t))}loadDBEntityFor(t,e="id",i){return p(this,void 0,void 0,(function*(){const n=(yield global.exports.oxmysql.query_async(`SELECT * FROM \`${this.dbTableName}\` WHERE ${e} = ?`,[t])).map((t=>(Object.keys(t).forEach((e=>{t[e]=JSON.parse(l(t[e].toString())?t[e]:`"${t[e]}"`,(function(t,e){return"object"==typeof e||isNaN(e)?e:Number(e)}))})),t)));return(null==n?void 0:n.length)?(n.forEach((t=>{this._entities.push(t),i&&this.bindEntityToPlayerByEntityId(t.id,i)})),setTimeout((()=>{this.syncWithClients()}),2e3),(null==n?void 0:n.length)>1?n:n[0]):null}))}loadDBEntities(){return p(this,void 0,void 0,(function*(){const t=(yield global.exports.oxmysql.query_async(`SELECT * FROM \`${this.dbTableName}\``,[])).map((t=>(Object.keys(t).forEach((e=>{t[e]=JSON.parse(l(t[e].toString())?t[e]:`"${t[e]}"`,(function(t,e){return"object"==typeof e||isNaN(e)?e:Number(e)}))})),t)));return(null==t?void 0:t.length)&&(this._entities=t,setTimeout((()=>{this.syncWithClients()}),2e3)),this._entities}))}getEntityProperties(t){const e=[];for(let i in t)"id"===i||this._cachedProperties.length&&!this._cachedProperties.includes(i)||e.push(i);return e}getEntityPropertiesValues(t,e){return e.map((e=>Array.isArray(t[e])||"object"==typeof t[e]?JSON.stringify(t[e]):t[e].toString()))}syncWithClients(t){TriggerClientEvent(`${GetCurrentResourceName()}:db-send-entities`,t||-1,this.entities)}bindEntityToPlayer(t,e){this.entities.includes(t)&&this.bindEntityToPlayerByEntityId(t.id,e)}bindEntityToPlayerByEntityId(t,e){this._entities.some((e=>e.id===t))&&(this._playerToEntityBindings.has(e)?this._playerToEntityBindings.set(e,[...this._playerToEntityBindings.get(e),t]):this._playerToEntityBindings.set(e,[t]))}onBoundEntityDestroyed(t,e){}onPlayerAuthenticate(t,e){this._entities.length&&this.syncWithClients(t)}onPlayerDisconnect(){this._playerToEntityBindings.has(source)&&((this._playerToEntityBindings.has(source)?this._playerToEntityBindings.get(source):[]).forEach((t=>{const e=this._entities.find((e=>e.id===t));e&&(this.onBoundEntityDestroyed(e,source),this._entities.splice(this._entities.indexOf(e),1))})),this._playerToEntityBindings.delete(source))}computeTableProperties(){return p(this,void 0,void 0,(function*(){const t=yield global.exports.oxmysql.query_async(`DESCRIBE ${this.dbTableName}`,[]);t?t.forEach((t=>{this._cachedProperties.push(t.Field)})):console.error(`[SQL ERROR:] computeTableProperties for ${GetCurrentResourceName()} did not work.`)}))}};h([a()],g.prototype,"getEntities",null),h([o()],g.prototype,"onPlayerAuthenticate",null),h([o()],g.prototype,"onPlayerDisconnect",null),g=h([s()],g);var E=function(t,e,i,n){var r,s=arguments.length,o=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(o=(s<3?r(o):s>3?r(e,i,o):r(e,i))||o);return s>3&&o&&Object.defineProperty(e,i,o),o},f=function(t,e,i,n){return new(i||(i=Promise))((function(r,s){function o(t){try{l(n.next(t))}catch(t){s(t)}}function a(t){try{l(n.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}l((n=n.apply(t,e||[])).next())}))};let R=class extends g{constructor(t,e){super(t,e),this.playerDBIdsWithReportTypes=new Map,this.initializeCache()}addToFactionActivityFor(t,e,i,n){this.playerDBIdsWithReportTypes.has(i)&&this.playerDBIdsWithReportTypes.get(i).includes(e)?global.exports.oxmysql.update_async(`UPDATE \`${this.dbTableName}\` SET points = points + ?, timestamp = ? WHERE playerDBId = ? AND type = ? AND factionInternalId = ?`,[n,Date.now(),i,e,t]):(this.createEntity({id:0,timestamp:Date.now(),points:n,playerDBId:i,type:e,factionInternalId:t}),this.playerDBIdsWithReportTypes.set(i,[...this.playerDBIdsWithReportTypes.has(i)?this.playerDBIdsWithReportTypes.get(i):[],e]))}getFactionActivityForMultipleAsync(t,e,i){return f(this,void 0,void 0,(function*(){const i=yield global.exports.oxmysql.query_async(`SELECT\n        playerDBId,\n        GROUP_CONCAT(timestamp ORDER BY CAST(SUBSTRING_INDEX(type, '-', -1) AS UNSIGNED)) AS timestamps,\n        GROUP_CONCAT(type ORDER BY CAST(SUBSTRING_INDEX(type, '-', -1) AS UNSIGNED)) AS types,\n        GROUP_CONCAT(points ORDER BY CAST(SUBSTRING_INDEX(type, '-', -1) AS UNSIGNED)) AS points\n        FROM ${this.dbTableName}\n        WHERE factionInternalId = ?\n        AND (${e.map((t=>"playerDBId="+t)).join(" OR ")})\n        GROUP BY playerDBId\n        ORDER BY playerDBId`,[t]);return i?i.reduce(((e,i)=>Object.assign(Object.assign({},e),{[i.playerDBId]:i.timestamps.split(",").map(((e,n)=>({id:0,factionInternalId:t,type:i.types.split(",")[n],timestamp:e,playerDBId:i.playerDBId,points:Number(i.points.split(",")[n])})))})),{}):{}}))}getFactionActivityForAsync(t,e,i=10){return f(this,void 0,void 0,(function*(){return(yield global.exports.oxmysql.query_async(`SELECT timestamp, content FROM \`${this.dbTableName}\` WHERE factionInternalId = ? ORDER BY timestamp DESC LIMIT ?`,[t,i])).map((t=>{const e=new Date(t.timestamp),i=new Date,n=e.setHours(0,0,0,0)===i.setHours(0,0,0,0)?this.translate("today"):`${e.getDate()}/${e.getMonth()+1}/${e.getFullYear()%100}`;return Object.assign(Object.assign({},t),{timestamp:n})}))}))}initializeCache(){return f(this,void 0,void 0,(function*(){const t=new Date,e=t.getDay()||7;t.setHours(1!==e?-24*(e-1):0,0,0,0),yield global.exports.oxmysql.query_async("DELETE FROM factions_activity WHERE timestamp < ?",[t.valueOf()]),(yield global.exports.oxmysql.query_async(`SELECT playerDBId, GROUP_CONCAT(type ORDER BY CAST(SUBSTRING_INDEX(type, '-', -1) AS UNSIGNED)) AS types FROM ${this.dbTableName} GROUP BY playerDBId ORDER BY playerDBId`)).forEach((t=>{this.playerDBIdsWithReportTypes.set(t.playerDBId,t.types.split(","))})),console.log(yield this.getFactionActivityForMultipleAsync("police",[1,2]))}))}};E([a()],R.prototype,"addToFactionActivityFor",null),E([a()],R.prototype,"getFactionActivityForMultipleAsync",null),E([a()],R.prototype,"getFactionActivityForAsync",null),R=E([s({translationFile:{en:{},ro:{}}})],R),new R("factions_activity",!1)})();