(()=>{"use strict";const e=(e,t,i,n,s,r,o)=>e>=n-o&&e<=n+o&&t>=s-o&&t<=s+o&&i>=r-o&&i<=r+o;var t=function(e,t,i,n){return new(i||(i=Promise))((function(s,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function a(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}l((n=n.apply(e,t||[])).next())}))};new class extends class extends class extends class extends class extends class{constructor(){this.routingBucketCondition=(e,t)=>!0,this.assignServerBaseListeners()}RegisterAdminCommand(e,t,i,n){RegisterCommand(e,((e,n,s)=>{Number(global.exports.authentication.getPlayerInfo(e,"adminLevel"))<t||i(e,n,s)}),n)}assignServerBaseListeners(){onNet(`${GetCurrentResourceName()}:set-client-routing-bucket`,((e,t)=>{this.routingBucketCondition(e,t)&&SetEntityRoutingBucket(e,t)}))}}{removeClientsideVehicles(){TriggerClientEvent(`${GetCurrentResourceName()}:ARM_remove-vehicles`,-1)}}{}{constructor(e){super(),this.dbTableName=e,this._entities=[],this.loadDBEntities(),this._assignExports(),this.assignDBEntityCommunicationListeners()}get entities(){return this._entities}getEntities(){return this._entities}createEntity(e){return(()=>t(this,void 0,void 0,(function*(){try{const t=this.getEntityProperties(e),i=this.getEntityPropertiesValues(e,t),n=yield global.exports.oxmysql.insert_async(`INSERT INTO \`${this.dbTableName}\` (${t.join(", ")}) VALUES (${Array(t.length).fill("?").join(", ")})`,i);return this._entities.push(Object.assign(Object.assign({},e),{id:n})),this.syncWithClients(),n}catch(e){return console.log(e),null}})))()}removeEntity(e){return(()=>t(this,void 0,void 0,(function*(){try{const t=yield global.exports.oxmysql.query_async(`DELETE FROM \`${this.dbTableName}\` WHERE id = ?`,[e.id]);return this._entities=this._entities.filter((t=>t.id!==e.id)),this.syncWithClients(),!!t}catch(e){return console.log(e),!1}})))()}saveDBEntityAsync(e){return(()=>t(this,void 0,void 0,(function*(){try{const t=this.getEntityByDBId(e),i=this.getEntityProperties(t),n=this.getEntityPropertiesValues(t,i),s=" = ?, ",r=yield global.exports.oxmysql.update_async(`UPDATE \`${this.dbTableName}\` SET ${i.join(s).concat(s).slice(0,-2)} WHERE id = ?`,[...n,t.id]);return r&&this.syncWithClients(),r>0}catch(e){return console.log(e),!1}})))()}getEntityByDBId(e){return this._entities.find((t=>t.id===e))}loadDBEntities(){setImmediate((()=>t(this,void 0,void 0,(function*(){const e=(yield global.exports.oxmysql.query_async(`SELECT * FROM \`${this.dbTableName}\``,[])).map((e=>(Object.keys(e).forEach((t=>{var i;e[t]=JSON.parse((i=e[t].toString(),!/^\s*$/.test(i)&&(i=(i=(i=i.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@")).replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]")).replace(/(?:^|:|,)(?:\s*\[)+/g,""),/^[\],:{}\s]*$/.test(i))?e[t]:`"${e[t]}"`),(function(e,t){return"object"==typeof t||isNaN(t)?t:Number(t)}))})),e)));(null==e?void 0:e.length)&&(this._entities=e,setTimeout((()=>{this.syncWithClients()}),2e3))}))))}getEntityProperties(e){const t=[];for(let i in e)"id"!==i&&t.push(i);return t}assignDBEntityCommunicationListeners(){onNet("authentication:player-authenticated",(e=>{this._entities.length&&this.syncWithClients(e)}))}getEntityPropertiesValues(e,t){return t.map((t=>Array.isArray(e[t])?JSON.stringify(e[t]):e[t].toString()))}syncWithClients(e){TriggerClientEvent(`${GetCurrentResourceName()}:db-send-entities`,e||-1,this.entities)}_assignExports(){exports("getEntities",this.getEntities.bind(this))}}{getClosestEntityOfSameTypeToPlayer(e){return this.getClosestEntityOfSameTypeExitToPlayer(e)||this.getClosestEntityOfSameTypeEntranceToPlayer(e)}getClosestEntityOfSameTypeEntranceToPlayer(t){const i=GetEntityCoords(GetPlayerPed(t),!0);return this.entities.find((t=>e(i[0],i[1],i[2],t.entranceX,t.entranceY,t.entranceZ,3)))||null}getClosestEntityOfSameTypeExitToPlayer(t){const i=GetEntityRoutingBucket(GetPlayerPed(t)),n=this.getEntityByDBId(i),s=GetEntityCoords(GetPlayerPed(t),!0);return n&&e(s[0],s[1],s[2],n.exitX,n.exitY,n.exitZ,3)?n:null}}{constructor(e){super(e),this.registerCommands(),this.registerExports(),this.registerListeners()}getOnlineFactionMembers(e){const t=this.entities.find((t=>t.internalId===e));return t?t.members.filter((e=>null!=e.onlineId)):[]}getAllFactionMembers(e){var t;return(null===(t=this.entities.find((t=>t.internalId===e)))||void 0===t?void 0:t.members)||[]}registerCommands(){this.RegisterAdminCommand("removefaction",6,((e,t)=>{let i=this.getClosestEntityOfSameTypeToPlayer(e);t&&t[0]&&(i=this.getEntityByDBId(Number(t[0]))||this.getClosestEntityOfSameTypeToPlayer(e)),i?(console.log(global.exports.authentication.getPlayerInfo(e,"name"),"removed a faction!"),this.removeEntity(i)):console.log("Failed - Faction undefined")}),!1),this.RegisterAdminCommand("createfaction",6,((e,t)=>{if(t.length<3)return void console.log("Syntax: /createfaction <factionId> <factionName>!");const i=t[0],n=t.slice(1).join(" "),s=GetEntityCoords(GetPlayerPed(e),!0);this.createEntity({name:n,internalId:i,blipId:-1,entranceX:s[0],entranceY:s[1],entranceZ:s[2],exitX:0,exitY:0,exitZ:0,members:[]})}),!1),RegisterCommand("factionmenu",(e=>{const t=this.entities.find((e=>"taxi"===e.internalId));t?TriggerClientEvent(`${GetCurrentResourceName()}:force-showui`,e,{stats:[{key:"Name",value:"Taxi Cab Company"},{key:"Leader",value:"Tony Delgado"},{key:"Members",value:"1"}],items:t.members.map((e=>({outline:"#404158",topLeft:"1",bottomRight:"",width:65,image:"1"}))),leftMenu:{description:"Faction Management",buttons:[{title:"Message Of The Day",subtitle:"Change the MOTD of the faction",icon:"campaign"},{title:"Schedule Meeting",subtitle:"Schedule a meeting with all members",icon:"groups"},{title:"Respawn Vehicles (FVR)",subtitle:"Respawn all faction vehicles.",icon:"rv_hookup"},{title:"Pay Salaries",subtitle:"Pay all salaries immediately",icon:"attach_money"}]},rightMenu:{description:"Individual Member Management",buttons:[{title:"Manage Privileges",subtitle:"Rank up/down, make tester, etc.",icon:"star_rate"},{title:"Manage Faction Sanctions",subtitle:"View, Add or Remove faction sanctions.",icon:"report"},{title:"Set Member Note",subtitle:"Set a note about this member.",icon:"shield"},{title:"Check Work Report",subtitle:"Check Member's Work Report.",icon:"shield"},{title:"Uninvite",subtitle:"Uninvite this member.",icon:"exit_to_app"}]},title:`Faction Menu - ${t.name} (${t.members.length} Members)`,resource:GetCurrentResourceName()}):console.log("Failed to show factionmenu to ",GetPlayerName(e))}),!1)}registerExports(){exports("getOnlineFactionMembers",this.getOnlineFactionMembers.bind(this)),exports("getAllFactionMembers",this.getAllFactionMembers.bind(this))}registerListeners(){onNet("authentication:player-authenticated",((e,t)=>{this.entities.forEach((i=>{const n=i.members.find((e=>e.id===t.id));n&&(n.onlineId=e)}))})),onNet("authentication:player-logout",(e=>{this.entities.forEach((t=>{const i=t.members.find((t=>t.onlineId===e));i&&(i.onlineId=null)}))}))}}("factions")})();