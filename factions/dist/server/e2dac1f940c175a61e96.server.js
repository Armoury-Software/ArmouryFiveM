(()=>{"use strict";const e={onPlayerDeath:"armoury:onPlayerDeath",onPlayerAuthenticate:"authentication:player-authenticated",onPlayerDisconnect:"playerDropped",onResourceStop:"onResourceStop",onContextMenuItemPressed:"armoury-overlay:context-menu-item-pressed",onPlayerEnterVehicle:"armoury:onPlayerEnterVehicle",onPlayerExitVehicle:"armoury:onPlayerExitVehicle",onPlayerClientsidedCacheLoaded:"armoury:player-resource-cache-loaded"};var t;!function(e){e[e.SERVER_TO_SERVER=0]="SERVER_TO_SERVER",e[e.SERVER_TO_CLIENT=1]="SERVER_TO_CLIENT",e[e.CLIENT_TO_SERVER=2]="CLIENT_TO_SERVER",e[e.CLIENT_TO_CLIENT=3]="CLIENT_TO_CLIENT"}(t||(t={}));const i=new Map,n=new Map,r=new Map;function o(){return function(e){return class extends e{constructor(...o){super(...o),i.has(e)&&i.get(e).forEach((([e,i,n])=>{n===t.CLIENT_TO_CLIENT?on(i,super[e].bind(this)):onNet(i,super[e].bind(this))})),n.has(e)&&n.get(e).forEach((e=>{exports(e,super[e].bind(this))})),r.has(e)&&r.get(e).forEach((([e,t])=>{RegisterCommand(e.toLowerCase(),((i,n,r)=>{Number(global.exports.authentication.getPlayerInfo(i,"adminLevel"))<t||super[e].call(this,i,n,r)}),!1)}))}}}}function s(n){return function(r,o,s){const a=e[o]||(null==n?void 0:n.eventName),l=(null==n?void 0:n.direction)||t.CLIENT_TO_SERVER;(null==a?void 0:a.length)?(i.has(r.constructor)||i.set(r.constructor,[]),i.get(r.constructor).some((([e,t,i])=>e===o))||i.get(r.constructor).push([o,a,l])):console.error(`${o} is not recognized as a default event, thus this listener won't work. Please use the eventName property inside the data parameter.`)}}function a(){return function(e,t,i){n.has(e.constructor)||n.set(e.constructor,[]),n.get(e.constructor).some((e=>e===t))||n.get(e.constructor).push(t)}}function l(e=0){return function(t,i,n){r.has(t.constructor)||r.set(t.constructor,[]),r.get(t.constructor).some((([e,t])=>e===i))||r.get(t.constructor).push([i,e])}}const c=(e,t,i,n,r,o,s)=>e>=n-s&&e<=n+s&&t>=r-s&&t<=r+s&&i>=o-s&&i<=o+s,u=e=>!/^\s*$/.test(e)&&(e=(e=(e=e.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@")).replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]")).replace(/(?:^|:|,)(?:\s*\[)+/g,""),/^[\],:{}\s]*$/.test(e));var d=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s};let h=class extends class{constructor(){this.routingBucketCondition=(e,t)=>!0,this.assignServerBaseListeners()}RegisterAdminCommand(e,t,i,n){RegisterCommand(e,((e,n,r)=>{Number(global.exports.authentication.getPlayerInfo(e,"adminLevel"))<t||i(e,n,r)}),n)}assignServerBaseListeners(){onNet(`${GetCurrentResourceName()}:set-client-routing-bucket`,((e,t)=>{this.routingBucketCondition(e,t)&&SetEntityRoutingBucket(e,t)}))}}{constructor(){super(...arguments),this._virtualWorldsWithPlayers=new Map}get virtualWorldsWithPlayers(){return this._virtualWorldsWithPlayers}onPlayerEnteredScope(e){TriggerClientEvent(`${GetCurrentResourceName()}:refresh-virtual-world`,e.for)}setPlayerVirtualWorld(e,t){const i=this.getPlayerVirtualWorld(e);isNaN(i)||this._virtualWorldsWithPlayers.set(i,(this._virtualWorldsWithPlayers.has(i)?this._virtualWorldsWithPlayers.get(i):[]).filter((t=>t!==e)));const n=[...this._virtualWorldsWithPlayers.has(t)?this._virtualWorldsWithPlayers.get(t):[],e];this._virtualWorldsWithPlayers.set(t,n),global.exports.authentication.setPlayerInfo(e,"virtualWorld",t)}getPlayerVirtualWorld(e){return Math.max(0,Number(global.exports.authentication.getPlayerInfo(e,"virtualWorld")))}removeClientsideVehicles(){TriggerClientEvent(`${GetCurrentResourceName()}:ARM_remove-vehicles`,-1)}};d([s({eventName:"playerEnteredScope"})],h.prototype,"onPlayerEnteredScope",null),h=d([o()],h);var y=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s};let p=class extends h{constructor(){super(...arguments),this._clientsidedResourceMap=new Map}get clientsidedResourceMap(){return this._clientsidedResourceMap}getPlayerClientsidedCacheKey(e,t){if(this._clientsidedResourceMap.has(e)){const i=this._clientsidedResourceMap.get(e);if(i[t])return i[t]}return null}updatePlayerClientsidedCacheKey(e,t,i){const n=this._clientsidedResourceMap.has(e)&&this._clientsidedResourceMap.get(e)||{};n[t]=i,this._clientsidedResourceMap.set(e,n),TriggerClientEvent("armoury-overlay:update-resource-metadata",e,GetCurrentResourceName(),t,i)}onPlayerClientsidedCacheLoaded(e){e[GetCurrentResourceName()]&&this._clientsidedResourceMap.set(source,e[GetCurrentResourceName()])}onPlayerDisconnect(){this._clientsidedResourceMap.has(source)&&this._clientsidedResourceMap.delete(source)}};y([s()],p.prototype,"onPlayerClientsidedCacheLoaded",null),y([s()],p.prototype,"onPlayerDisconnect",null),p=y([o()],p);var g=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},m=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{l(n.next(e))}catch(e){o(e)}}function a(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}l((n=n.apply(e,t||[])).next())}))};let f=class extends p{constructor(e,t=!1){super(),this.dbTableName=e,this._entities=[],this._cachedProperties=[],this._playerToEntityBindings=new Map,this.computeTableProperties(),t&&this.loadDBEntities()}get entities(){return this._entities}get cachedProperties(){return this._cachedProperties}get playerToEntityBindings(){return this._playerToEntityBindings}getEntities(){return this._entities}createEntity(e,t){return(()=>m(this,void 0,void 0,(function*(){try{let i=this.getEntityProperties(e),n=this.getEntityPropertiesValues(e,i);t&&(i=["id",...i],n=[t.toString(),...n]);const r=yield global.exports.oxmysql.insert_async(`INSERT INTO \`${this.dbTableName}\` (${i.join(", ")}) VALUES (${Array(i.length).fill("?").join(", ")})`,n),o=Object.assign(Object.assign({},e),{id:t||r});return this._entities.push(o),this.syncWithClients(),o}catch(e){return console.log(e),null}})))()}removeEntity(e){return(()=>m(this,void 0,void 0,(function*(){try{const t=yield global.exports.oxmysql.query_async(`DELETE FROM \`${this.dbTableName}\` WHERE id = ?`,[e.id]);return this._entities=this._entities.filter((t=>t.id!==e.id)),this.syncWithClients(),!!t}catch(e){return console.log(e),!1}})))()}saveDBEntityAsync(e){return(()=>m(this,void 0,void 0,(function*(){try{const t=this.getEntityByDBId(e),i=this.getEntityProperties(t),n=this.getEntityPropertiesValues(t,i),r=" = ?, ",o=yield global.exports.oxmysql.update_async(`UPDATE \`${this.dbTableName}\` SET ${i.join(r).concat(r).slice(0,-2)} WHERE id = ?`,[...n,t.id]);return o&&this.syncWithClients(),o>0}catch(e){return console.log(e),!1}})))()}getEntityByDBId(e){return this._entities.find((t=>t.id===e))}loadDBEntityFor(e,t="id",i){return m(this,void 0,void 0,(function*(){const n=(yield global.exports.oxmysql.query_async(`SELECT * FROM \`${this.dbTableName}\` WHERE ${t} = ?`,[e])).map((e=>(Object.keys(e).forEach((t=>{e[t]=JSON.parse(u(e[t].toString())?e[t]:`"${e[t]}"`,(function(e,t){return"object"==typeof t||isNaN(t)?t:Number(t)}))})),e)));return(null==n?void 0:n.length)?(n.forEach((e=>{this._entities.push(e),i&&this.bindEntityToPlayerByEntityId(e.id,i)})),setTimeout((()=>{this.syncWithClients()}),2e3),(null==n?void 0:n.length)>1?n:n[0]):null}))}loadDBEntities(){return m(this,void 0,void 0,(function*(){const e=(yield global.exports.oxmysql.query_async(`SELECT * FROM \`${this.dbTableName}\``,[])).map((e=>(Object.keys(e).forEach((t=>{e[t]=JSON.parse(u(e[t].toString())?e[t]:`"${e[t]}"`,(function(e,t){return"object"==typeof t||isNaN(t)?t:Number(t)}))})),e)));return(null==e?void 0:e.length)&&(this._entities=e,setTimeout((()=>{this.syncWithClients()}),2e3)),this._entities}))}getEntityProperties(e){const t=[];for(let i in e)"id"===i||this._cachedProperties.length&&!this._cachedProperties.includes(i)||t.push(i);return t}getEntityPropertiesValues(e,t){return t.map((t=>Array.isArray(e[t])||"object"==typeof e[t]?JSON.stringify(e[t]):e[t].toString()))}syncWithClients(e){TriggerClientEvent(`${GetCurrentResourceName()}:db-send-entities`,e||-1,this.entities)}bindEntityToPlayer(e,t){this.entities.includes(e)&&this.bindEntityToPlayerByEntityId(e.id,t)}bindEntityToPlayerByEntityId(e,t){this._entities.some((t=>t.id===e))&&(this._playerToEntityBindings.has(t)?this._playerToEntityBindings.set(t,[...this._playerToEntityBindings.get(t),e]):this._playerToEntityBindings.set(t,[e]))}onBoundEntityDestroyed(e,t){}onPlayerAuthenticate(e,t){this._entities.length&&this.syncWithClients(e)}onPlayerDisconnect(){this._playerToEntityBindings.has(source)&&((this._playerToEntityBindings.has(source)?this._playerToEntityBindings.get(source):[]).forEach((e=>{const t=this._entities.find((t=>t.id===e));t&&(this.onBoundEntityDestroyed(t,source),this._entities.splice(this._entities.indexOf(t),1))})),this._playerToEntityBindings.delete(source))}computeTableProperties(){return m(this,void 0,void 0,(function*(){const e=yield global.exports.oxmysql.query_async(`DESCRIBE ${this.dbTableName}`,[]);e?e.forEach((e=>{this._cachedProperties.push(e.Field)})):console.error(`[SQL ERROR:] computeTableProperties for ${GetCurrentResourceName()} did not work.`)}))}};g([a()],f.prototype,"getEntities",null),g([s()],f.prototype,"onPlayerAuthenticate",null),g([s()],f.prototype,"onPlayerDisconnect",null),f=g([o()],f);class E extends f{getClosestEntityOfSameTypeToPlayer(e){return this.getClosestEntityOfSameTypeExitToPlayer(e)||this.getClosestEntityOfSameTypeEntranceToPlayer(e)}getClosestEntityOfSameTypeEntranceToPlayer(e){const t=GetEntityCoords(GetPlayerPed(e),!0);return this.entities.find((e=>c(t[0],t[1],t[2],e.entranceX,e.entranceY,e.entranceZ,3)))||null}getClosestEntityOfSameTypeExitToPlayer(e){const t=Math.max(0,Number(global.exports.authentication.getPlayerInfo(e,"virtualWorld"))),i=this.getEntityByDBId(t),n=GetEntityCoords(GetPlayerPed(e),!0);return i&&c(n[0],n[1],n[2],i.exitX,i.exitY,i.exitZ,3)?i:null}}var b=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s};let P=class extends E{constructor(e){super(e,!0),this.registerCommands(),this.registerExports(),this.registerListeners()}enterFaction(e){const t=this.getClosestEntityOfSameTypeEntranceToPlayer(e);t?(SetEntityCoords(GetPlayerPed(e),t.exitX,t.exitY,t.exitZ,!0,!1,!1,!0),SetEntityRoutingBucket(GetPlayerPed(e),t.id)):global.exports.chat.addMessage(e,"Couldn't find a valid faction entrance.")}exitFaction(e){const t=this.getClosestEntityOfSameTypeExitToPlayer(e);t?(SetEntityCoords(GetPlayerPed(e),t.entranceX,t.entranceY,t.entranceZ,!0,!1,!1,!0),SetEntityRoutingBucket(GetPlayerPed(e),0)):global.exports.chat.addMessage(e,"Couldn't find a valid faction exit.")}getOnlineFactionMembers(e){const t=this.entities.find((t=>t.internalId===e));return t?t.members.filter((e=>null!=e.onlineId)):[]}getAllFactionMembers(e){var t;return(null===(t=this.entities.find((t=>t.internalId===e)))||void 0===t?void 0:t.members)||[]}getFaction(e){return this.entities.find((t=>t.internalId===e))}isPlayerMemberOfFaction(e,t){var i;return null===(i=this.getFaction(e))||void 0===i?void 0:i.members.some((e=>e.onlineId===t))}getFactionMemberRank(e,t){var i,n;return Number(null===(n=null===(i=this.getFaction(e))||void 0===i?void 0:i.members.find((e=>e.onlineId===t)))||void 0===n?void 0:n.rank)}registerCommands(){this.RegisterAdminCommand("removefaction",6,((e,t)=>{let i=this.getClosestEntityOfSameTypeToPlayer(e);t&&t[0]&&(i=this.getEntityByDBId(Number(t[0]))||this.getClosestEntityOfSameTypeToPlayer(e)),i?(console.log(global.exports.authentication.getPlayerInfo(e,"name"),"removed a faction!"),this.removeEntity(i)):console.log("Failed - Faction undefined")}),!1),this.RegisterAdminCommand("createfaction",6,((e,t)=>{if(t.length<3)return void console.log("Syntax: /createfaction <factionId> <factionName>!");const i=t[0],n=t.slice(1).join(" "),r=GetEntityCoords(GetPlayerPed(e),!0);this.createEntity({name:n,internalId:i,blipId:-1,entranceX:r[0],entranceY:r[1],entranceZ:r[2],exitX:0,exitY:0,exitZ:0,members:[]})}),!1),RegisterCommand("factionmenu",(e=>{const t=this.entities.find((e=>"taxi"===e.internalId));t?TriggerClientEvent(`${GetCurrentResourceName()}:force-showui`,e,{stats:[{key:"Name",value:"Taxi Cab Company"},{key:"Leader",value:"Tony Delgado"},{key:"Members",value:"1"}],items:t.members.map((e=>({outline:"#404158",topLeft:"1",bottomRight:"",width:65,image:"1"}))),leftMenu:{description:"Faction Management",buttons:[{title:"Message Of The Day",subtitle:"Change the MOTD of the faction",icon:"campaign"},{title:"Schedule Meeting",subtitle:"Schedule a meeting with all members",icon:"groups"},{title:"Respawn Vehicles (FVR)",subtitle:"Respawn all faction vehicles.",icon:"rv_hookup"},{title:"Pay Salaries",subtitle:"Pay all salaries immediately",icon:"attach_money"}]},rightMenu:{description:"Individual Member Management",buttons:[{title:"Manage Privileges",subtitle:"Rank up/down, make tester, etc.",icon:"star_rate"},{title:"Manage Faction Sanctions",subtitle:"View, Add or Remove faction sanctions.",icon:"report"},{title:"Set Member Note",subtitle:"Set a note about this member.",icon:"shield"},{title:"Check Work Report",subtitle:"Check Member's Work Report.",icon:"shield"},{title:"Uninvite",subtitle:"Uninvite this member.",icon:"exit_to_app"}]},title:`Faction Menu - ${t.name} (${t.members.length} Members)`,resource:GetCurrentResourceName()}):console.log("Failed to show factionmenu to ",GetPlayerName(e))}),!1)}registerExports(){exports("getOnlineFactionMembers",this.getOnlineFactionMembers.bind(this)),exports("getAllFactionMembers",this.getAllFactionMembers.bind(this)),exports("getFaction",this.getFaction.bind(this))}registerListeners(){onNet("authentication:player-authenticated",((e,t)=>{this.entities.forEach((i=>{const n=i.members.find((e=>e.id===t.id));n&&(n.onlineId=e)}))})),onNet("authentication:player-logout",(e=>{this.entities.forEach((t=>{const i=t.members.find((t=>t.onlineId===e));i&&(i.onlineId=null)}))}))}};b([l()],P.prototype,"enterFaction",null),b([l()],P.prototype,"exitFaction",null),b([a()],P.prototype,"isPlayerMemberOfFaction",null),b([a()],P.prototype,"getFactionMemberRank",null),P=b([o()],P),new P("factions")})();