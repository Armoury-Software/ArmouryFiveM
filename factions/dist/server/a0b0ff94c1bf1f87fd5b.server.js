(()=>{"use strict";const e={onAccountAuthenticate:"authentication:account-success",onPlayerConnect:"playerJoining",onPlayerDeath:"armoury:onPlayerDeath",onPlayerAuthenticate:"authentication:player-authenticated",onPlayerDisconnect:"playerDropped",onResourceStop:"onResourceStop",onContextMenuItemPressed:"armoury-overlay:context-menu-item-pressed",onPlayerEnterVehicle:"armoury:onPlayerEnterVehicle",onPlayerExitVehicle:"armoury:onPlayerExitVehicle",onPlayerClientsidedCacheLoaded:"armoury:player-resource-cache-loaded",onPlayerStartTowVehicle:"armoury:onPlayerStartTowVehicle",onPlayerStopTowVehicle:"armoury:onPlayerStopTowVehicle"};var t;!function(e){e[e.SERVER_TO_SERVER=0]="SERVER_TO_SERVER",e[e.SERVER_TO_CLIENT=1]="SERVER_TO_CLIENT",e[e.CLIENT_TO_SERVER=2]="CLIENT_TO_SERVER",e[e.CLIENT_TO_CLIENT=3]="CLIENT_TO_CLIENT"}(t||(t={}));const n=new Map,i=new Map,a=new Map;function r(e){return function(r){return class extends r{constructor(...s){super(...s),this.translationFile=null==e?void 0:e.translationFile,n.has(r)&&n.get(r).forEach((([e,n,i])=>{i===t.CLIENT_TO_CLIENT?on(n,super[e].bind(this)):onNet(n,super[e].bind(this))})),i.has(r)&&i.get(r).forEach((e=>{exports(e,super[e].bind(this))})),a.has(r)&&a.get(r).forEach((([e,t])=>{IsDuplicityVersion()?RegisterCommand(e.toLowerCase(),((n,i,a)=>{Number(global.exports.authentication.getPlayerInfo(n,"adminLevel"))<t||super[e].call(this,n,i,a)}),!1):RegisterCommand(e.toLowerCase(),((t,n,i)=>{super[e].call(this,n,i)}),!1)}))}}}}function s(i){return function(a,r,s){const o=e[r]||(null==i?void 0:i.eventName),l=(null==i?void 0:i.direction)||t.CLIENT_TO_SERVER;(null==o?void 0:o.length)?(n.has(a.constructor)||n.set(a.constructor,[]),n.get(a.constructor).some((([e,t,n])=>e===r))||n.get(a.constructor).push([r,o,l])):console.error(`${r} is not recognized as a default event, thus this listener won't work. Please use the eventName property inside the data parameter.`)}}function o(){return function(e,t,n){i.has(e.constructor)||i.set(e.constructor,[]),i.get(e.constructor).some((e=>e===t))||i.get(e.constructor).push(t)}}function l(e=0){return function(t,n,i){a.has(t.constructor)||a.set(t.constructor,[]),a.get(t.constructor).some((([e,t])=>e===n))||a.get(t.constructor).push([n,e])}}const c=(e,t,n,i,a,r,s)=>e>=i-s&&e<=i+s&&t>=a-s&&t<=a+s&&n>=r-s&&n<=r+s,u=e=>!/^\s*$/.test(e)&&(e=(e=(e=e.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@")).replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]")).replace(/(?:^|:|,)(?:\s*\[)+/g,""),/^[\],:{}\s]*$/.test(e));var d=function(e,t,n,i){var a,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(s=(r<3?a(s):r>3?a(t,n,s):a(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s};let m=class extends class{constructor(){this.routingBucketCondition=(e,t)=>!0,this.assignServerBaseListeners()}RegisterAdminCommand(e,t,n,i){RegisterCommand(e,((e,i,a)=>{Number(global.exports.authentication.getPlayerInfo(e,"adminLevel"))<t||n(e,i,a)}),i)}assignServerBaseListeners(){onNet(`${GetCurrentResourceName()}:set-client-routing-bucket`,((e,t)=>{this.routingBucketCondition(e,t)&&SetEntityRoutingBucket(e,t)}))}setRoutingBucket(e,t){SetEntityRoutingBucket(GetPlayerPed(e),t),TriggerClientEvent(`${GetCurrentResourceName()}:set-routing-bucket`,e,t)}}{constructor(){super(...arguments),this._virtualWorldsWithPlayers=new Map}get virtualWorldsWithPlayers(){return this._virtualWorldsWithPlayers}onPlayerEnteredScope(e){TriggerClientEvent(`${GetCurrentResourceName()}:refresh-virtual-world`,e.for)}setPlayerVirtualWorld(e,t){const n=this.getPlayerVirtualWorld(e);isNaN(n)||this._virtualWorldsWithPlayers.set(n,(this._virtualWorldsWithPlayers.has(n)?this._virtualWorldsWithPlayers.get(n):[]).filter((t=>t!==e)));const i=[...this._virtualWorldsWithPlayers.has(t)?this._virtualWorldsWithPlayers.get(t):[],e];this._virtualWorldsWithPlayers.set(t,i),global.exports.authentication.setPlayerInfo(e,"virtualWorld",t)}getPlayerVirtualWorld(e){return Math.max(0,Number(global.exports.authentication.getPlayerInfo(e,"virtualWorld")))}removeClientsideVehicles(){TriggerClientEvent(`${GetCurrentResourceName()}:ARM_remove-vehicles`,-1)}};d([s({eventName:"playerEnteredScope"})],m.prototype,"onPlayerEnteredScope",null),m=d([r()],m);var h=function(e,t,n,i){var a,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(s=(r<3?a(s):r>3?a(t,n,s):a(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s};let g=class extends m{constructor(){super(...arguments),this._translationLanguage="ro",this._clientsidedResourceMap=new Map}get translationLanguage(){return this._translationLanguage}get clientsidedResourceMap(){return this._clientsidedResourceMap}getPlayerClientsidedCacheKey(e,t){if(this._clientsidedResourceMap.has(e)){const n=this._clientsidedResourceMap.get(e);if(n[t])return n[t]}return null}updatePlayerClientsidedCacheKey(e,t,n){const i=this._clientsidedResourceMap.has(e)&&this._clientsidedResourceMap.get(e)||{};i[t]=n,this._clientsidedResourceMap.set(e,i),TriggerClientEvent("armoury-overlay:update-resource-metadata",e,GetCurrentResourceName(),t,n)}onPlayerClientsidedCacheLoaded(e){e[GetCurrentResourceName()]&&this._clientsidedResourceMap.set(source,e[GetCurrentResourceName()])}onPlayerDisconnect(){this._clientsidedResourceMap.has(source)&&this._clientsidedResourceMap.delete(source)}translate(e,t){let n=this.translationFile[this._translationLanguage][e];return t&&Object.keys(t).forEach((e=>{n=n.replace(`{${e}}`,t[e])})),n}setTranslationLanguage(e){this._translationLanguage=e}};h([s()],g.prototype,"onPlayerClientsidedCacheLoaded",null),h([s()],g.prototype,"onPlayerDisconnect",null),g=h([r()],g);var y=function(e,t,n,i){var a,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(s=(r<3?a(s):r>3?a(t,n,s):a(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s},_=function(e,t,n,i){return new(n||(n=Promise))((function(a,r){function s(e){try{l(i.next(e))}catch(e){r(e)}}function o(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,o)}l((i=i.apply(e,t||[])).next())}))};let p=class extends g{constructor(e,t=!1){super(),this.dbTableName=e,this._entities=[],this._cachedProperties=[],this._playerToEntityBindings=new Map,this.computeTableProperties(),t&&this.loadDBEntities()}get entities(){return this._entities}get cachedProperties(){return this._cachedProperties}get playerToEntityBindings(){return this._playerToEntityBindings}getEntities(){return this._entities}createEntity(e,t){return(()=>_(this,void 0,void 0,(function*(){try{let n=this.getEntityProperties(e),i=this.getEntityPropertiesValues(e,n);t&&(n=["id",...n],i=[t.toString(),...i]);const a=yield global.exports.oxmysql.insert_async(`INSERT INTO \`${this.dbTableName}\` (${n.join(", ")}) VALUES (${Array(n.length).fill("?").join(", ")})`,i),r=Object.assign(Object.assign({},e),{id:t||a});return this._entities.push(r),this.syncWithClients(),r}catch(e){return console.log(e),null}})))()}removeEntity(e){return(()=>_(this,void 0,void 0,(function*(){try{const t=yield global.exports.oxmysql.query_async(`DELETE FROM \`${this.dbTableName}\` WHERE id = ?`,[e.id]);return this._entities=this._entities.filter((t=>t.id!==e.id)),this.syncWithClients(),!!t}catch(e){return console.log(e),!1}})))()}saveDBEntityAsync(e){return(()=>_(this,void 0,void 0,(function*(){try{const t=this.getEntityByDBId(e),n=this.getEntityProperties(t),i=this.getEntityPropertiesValues(t,n),a=" = ?, ",r=yield global.exports.oxmysql.update_async(`UPDATE \`${this.dbTableName}\` SET ${n.join(a).concat(a).slice(0,-2)} WHERE id = ?`,[...i,t.id]);return r&&this.syncWithClients(),r>0}catch(e){return console.log(e),!1}})))()}getEntityByDBId(e){return this._entities.find((t=>t.id===e))}loadDBEntityFor(e,t="id",n){return _(this,void 0,void 0,(function*(){const i=(yield global.exports.oxmysql.query_async(`SELECT * FROM \`${this.dbTableName}\` WHERE ${t} = ?`,[e])).map((e=>(Object.keys(e).forEach((t=>{e[t]=JSON.parse(u(e[t].toString())?e[t]:`"${e[t]}"`,(function(e,t){return"object"==typeof t||isNaN(t)?t:Number(t)}))})),e)));return(null==i?void 0:i.length)?(i.forEach((e=>{this._entities.push(e),n&&this.bindEntityToPlayerByEntityId(e.id,n)})),setTimeout((()=>{this.syncWithClients()}),2e3),(null==i?void 0:i.length)>1?i:i[0]):null}))}loadDBEntities(){return _(this,void 0,void 0,(function*(){const e=(yield global.exports.oxmysql.query_async(`SELECT * FROM \`${this.dbTableName}\``,[])).map((e=>(Object.keys(e).forEach((t=>{e[t]=JSON.parse(u(e[t].toString())?e[t]:`"${e[t]}"`,(function(e,t){return"object"==typeof t||isNaN(t)?t:Number(t)}))})),e)));return(null==e?void 0:e.length)&&(this._entities=e,setTimeout((()=>{this.syncWithClients()}),2e3)),this._entities}))}getEntityProperties(e){const t=[];for(let n in e)"id"===n||this._cachedProperties.length&&!this._cachedProperties.includes(n)||t.push(n);return t}getEntityPropertiesValues(e,t){return t.map((t=>Array.isArray(e[t])||"object"==typeof e[t]?JSON.stringify(e[t]):e[t].toString()))}syncWithClients(e){TriggerClientEvent(`${GetCurrentResourceName()}:db-send-entities`,e||-1,this.entities)}bindEntityToPlayer(e,t){this.entities.includes(e)&&this.bindEntityToPlayerByEntityId(e.id,t)}bindEntityToPlayerByEntityId(e,t){this._entities.some((t=>t.id===e))&&(this._playerToEntityBindings.has(t)?this._playerToEntityBindings.set(t,[...this._playerToEntityBindings.get(t),e]):this._playerToEntityBindings.set(t,[e]))}onBoundEntityDestroyed(e,t){}onPlayerAuthenticate(e,t){this._entities.length&&this.syncWithClients(e)}onPlayerDisconnect(){this._playerToEntityBindings.has(source)&&((this._playerToEntityBindings.has(source)?this._playerToEntityBindings.get(source):[]).forEach((e=>{const t=this._entities.find((t=>t.id===e));t&&(this.onBoundEntityDestroyed(t,source),this._entities.splice(this._entities.indexOf(t),1))})),this._playerToEntityBindings.delete(source))}computeTableProperties(){return _(this,void 0,void 0,(function*(){const e=yield global.exports.oxmysql.query_async(`DESCRIBE ${this.dbTableName}`,[]);e?e.forEach((e=>{this._cachedProperties.push(e.Field)})):console.error(`[SQL ERROR:] computeTableProperties for ${GetCurrentResourceName()} did not work.`)}))}};y([o()],p.prototype,"getEntities",null),y([s()],p.prototype,"onPlayerAuthenticate",null),y([s()],p.prototype,"onPlayerDisconnect",null),p=y([r()],p);class f extends p{getClosestEntityOfSameTypeToPlayer(e){return this.getClosestEntityOfSameTypeExitToPlayer(e)||this.getClosestEntityOfSameTypeEntranceToPlayer(e)}getClosestEntityOfSameTypeEntranceToPlayer(e){const t=GetEntityCoords(GetPlayerPed(e),!0);return this.entities.find((e=>c(t[0],t[1],t[2],e.entranceX,e.entranceY,e.entranceZ,3)))||null}getClosestEntityOfSameTypeExitToPlayer(e){const t=this.getPlayerVirtualWorld(e)||0,n=this.getEntityByDBId(t),i=GetEntityCoords(GetPlayerPed(e),!0);return n&&c(i[0],i[1],i[2],n.exitX,n.exitY,n.exitZ,3)?n:null}}var b=function(e,t,n,i){var a,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(s=(r<3?a(s):r>3?a(t,n,s):a(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s},v=function(e,t,n,i){return new(n||(n=Promise))((function(a,r){function s(e){try{l(i.next(e))}catch(e){r(e)}}function o(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,o)}l((i=i.apply(e,t||[])).next())}))};let k=class extends f{constructor(){super(...arguments),this.onlinePlayersWithFactions=new Map,this.factionsWithOnlinePlayers=new Map,this.leadersManagingRanks=new Map,this.leadersSanctioningPlayers=new Map,this.leadersManagingTesterStatuses=new Map,this.leadersKickingPlayers=new Map}onConfirmKickMember(){const e=source;if(!this.leadersKickingPlayers.has(e))return;const t=this.getPlayerFactionWhoTheyAreLeaderFor(e);if(!t)return;const n=t.members.find((t=>t.id===this.leadersKickingPlayers.get(e)));n&&(t.members=t.members.filter((t=>t.id!==this.leadersKickingPlayers.get(e))),global.exports["factions-logs"].addToFactionLog(t.internalId,`${t.rankNames[6]} (6) ${global.exports.authentication.getPlayerInfo(e,"name")} l-a dat afara din factiune pe ${n.onlineName}. (concediere)`),this.saveDBEntityAsync(t.id),this.leadersKickingPlayers.delete(e),this.factionMenu(e))}onRequestKickMember(e){if(!e||!Number(e))return;const t=source;this.getPlayerFactionWhoTheyAreLeaderFor(t)&&(TriggerClientEvent(`${GetCurrentResourceName()}:show-dialog`,t,{title:this.translate("title_member_kick"),content:this.translate("title_member_kick_confirmation"),dialogId:"faction-confirm-kick-member",buttons:[{title:this.translate("confirm")}]}),this.leadersKickingPlayers.set(t,e))}onConfirmWarnMember(){const e=source;if(!this.leadersSanctioningPlayers.has(e))return;const t=this.getPlayerFactionWhoTheyAreLeaderFor(e);if(!t)return;let n=null;const i=this.leadersSanctioningPlayers.get(e).newSanctionsNumber;t.members=[...t.members.map((a=>a.id===this.leadersSanctioningPlayers.get(e).id?(i>=3&&(n=a),i<a.warnings?global.exports["factions-logs"].addToFactionLog(t.internalId,`${t.rankNames[6]} (6) ${global.exports.authentication.getPlayerInfo(e,"name")} i-a scos o sanctiune lui ${a.onlineName}. (${i}/3)`):n===a?global.exports["factions-logs"].addToFactionLog(t.internalId,`${t.rankNames[6]} (6) ${global.exports.authentication.getPlayerInfo(e,"name")} l-a dat afara din factiune pe ${a.onlineName}. (${i}/3)`):global.exports["factions-logs"].addToFactionLog(t.internalId,`${t.rankNames[6]} (6) ${global.exports.authentication.getPlayerInfo(e,"name")} i-a adaugat o sanctiune lui ${a.onlineName}. (${i}/3)`),Object.assign(Object.assign({},a),{warnings:i})):a))],n&&(t.members=t.members.filter((e=>e.id!==n.id))),this.saveDBEntityAsync(t.id),this.leadersSanctioningPlayers.get(e).wasPreviouslyInMenu?this.onRequestManageSanctions(!0,e):this.factionMenu(e),this.leadersSanctioningPlayers.delete(e),this.factionMenu(e)}onRequestWarnMember(e,t,n=!1){if(!e||!Number(e))return;const i=source,a=this.getPlayerFactionWhoTheyAreLeaderFor(i);if(!a)return;const r=a.members.find((t=>t.id===e));r&&(TriggerClientEvent(`${GetCurrentResourceName()}:show-dialog`,i,{title:this.translate(`title_member_${t<1?"un":""}warn`),content:this.translate(`title_member_${t<1?"un":""}warn_confirmation`),dialogId:"faction-confirm-warn-member",buttons:[{title:this.translate("confirm")}]}),this.leadersSanctioningPlayers.set(i,{id:e,newSanctionsNumber:r.warnings+t,wasPreviouslyInMenu:n}))}onConfirmModifyTesterStatus(){const e=source;if(!this.leadersManagingTesterStatuses.has(e))return;const t=this.getPlayerFactionWhoTheyAreLeaderFor(e);if(!t)return;const n=t.members.find((t=>t.id===this.leadersManagingRanks.get(e).id));if(!n)return;t.members=[...t.members.map((t=>Object.assign(Object.assign({},t),{tester:t.id===this.leadersManagingTesterStatuses.get(e).id?this.leadersManagingTesterStatuses.get(e).newTesterStatus:t.tester})))];const i=this.leadersManagingTesterStatuses.get(e).newTesterStatus;i&&global.exports["factions-logs"].addToFactionLog(t.internalId,`${t.rankNames[6]} (6) ${global.exports.authentication.getPlayerInfo(e,"name")} i-a ${i?"acordat":"revocat"} gradul de tester lui ${n.onlineName}.`),this.saveDBEntityAsync(t.id),this.leadersManagingTesterStatuses.delete(e),this.onRequestManagePrivileges(!0,e),this.factionMenu(e)}onRequestModifyTesterStatus(e,t){if(!e||!Number(e))return;const n=source,i=this.getPlayerFactionWhoTheyAreLeaderFor(n);if(!i)return;const a=i.members.find((t=>t.id===Number(e)));if(!a)return;TriggerClientEvent(`${GetCurrentResourceName()}:show-dialog`,source,{title:this.translate(`title_member_tester_${a.tester?"un":""}make`),content:this.translate(`title_member_tester_${a.tester?"un":""}make_confirmation`),dialogId:"faction-confirm-manage-member-tester-status",buttons:[{title:this.translate("confirm")}]});const r=!a.tester;this.leadersManagingTesterStatuses.set(n,{newTesterStatus:r,id:Number(e),onlineId:a.onlineId||void 0})}onConfirmIncrementRank(){const e=source;if(!this.leadersManagingRanks.has(e))return;const t=this.getPlayerFactionWhoTheyAreLeaderFor(e);if(!t)return;const n=t.members.find((t=>t.id===this.leadersManagingRanks.get(e).id));if(!n)return;const i=this.leadersManagingRanks.get(e).newRank;t.members=[...t.members.map((a=>a.id===this.leadersManagingRanks.get(e).id?(global.exports["factions-logs"].addToFactionLog(t.internalId,`${t.rankNames[6]} (6) ${global.exports.authentication.getPlayerInfo(e,"name")} i-a ${i<a.rank?"scazut":"crescut"} rank-ul lui ${n.onlineName} (${i}).`),Object.assign(Object.assign({},a),{rank:i})):a))],this.saveDBEntityAsync(t.id),this.leadersManagingRanks.delete(e),this.onRequestManagePrivileges(!0,e),this.factionMenu(e)}onRequestIncrementRank(e,t,n){if(!e||!Number(e))return;const i=source,a=this.getPlayerFactionWhoTheyAreLeaderFor(i);if(!a)return;const r=a.members.find((t=>t.id===Number(e))),s=null==r?void 0:r.rank;if(!r||!s)return;TriggerClientEvent(`${GetCurrentResourceName()}:show-dialog`,source,{title:this.translate("title_member_rank_"+(n>0?"up":"down")),content:this.translate(`title_member_rank_${n>0?"up":"down"}_confirmation`),dialogId:"faction-confirm-manage-member-rank",buttons:[{title:this.translate("confirm")}]});const o=s+Number(n);this.leadersManagingRanks.set(i,{newRank:o,id:Number(e),onlineId:r.onlineId||void 0})}onRequestManageActivity(e=!1,t){const n=null!=t?t:source,i=this.getPlayerFactionWhoTheyAreLeaderFor(n);i&&setImmediate((()=>v(this,void 0,void 0,(function*(){const t=yield global.exports["factions-activity"].getFactionActivityForMultipleAsync(i.internalId,i.members.map((e=>e.id))),a=(yield this.getAllFactionMembersAsync(i.internalId,!0)).map((e=>Object.assign(Object.assign({},e),{activity:t[e.id]||[]})));TriggerClientEvent(`${GetCurrentResourceName()}:${e?"update-dialog":"show-dialog"}`,n,{width:500,title:this.translate("activity_manage"),content:this.translate("activity_manage_description"),dialogId:"faction-member-activities",dialogComponents:[{type:"stats",metadata:{items:a.sort(((e,t)=>e.rank>t.rank?-1:1)).map((e=>{const t=Math.round(Math.abs((Date.now()-e.hireTimestamp)/864e5));return Object.assign({title:e.name+(e.onlineId===n?` (${this.translate("you")}), `:", ")+`${i.rankNames[e.rank]||"Unnamed rank"} (${e.rank})`+` (${this.translate("seniority")}: ${t} ${this.translate("days")})`},e.activity.reduce(((e,t)=>Object.assign(Object.assign({},e),{[`${this.translate(t.type)}`]:`${t.points} ${this.translate("points")}`})),{}))}))}}],buttons:[{title:this.translate("confirm")}]})}))))}onRequestManageSanctions(e=!1,t){const n=null!=t?t:source,i=this.getPlayerFactionWhoTheyAreLeaderFor(n);i&&setImmediate((()=>v(this,void 0,void 0,(function*(){TriggerClientEvent(`${GetCurrentResourceName()}:${e?"update-dialog":"show-dialog"}`,n,{width:370,title:this.translate("sanctions_manage"),content:this.translate("sanctions_manage_description"),dialogId:"faction-member-privileges",dialogComponents:[{type:"stats",metadata:{items:(yield this.getAllFactionMembersAsync(i.internalId,!0)).sort(((e,t)=>e.rank>t.rank?-1:1)).map((e=>{const t=Math.round(Math.abs((Date.now()-e.hireTimestamp)/864e5));return{title:e.name+(e.onlineId===n?` (${this.translate("you")})`:""),rank:`${i.rankNames[e.rank]||"Unnamed rank"} (${e.rank})`,[this.translate("labels_hire_date")]:new Date(e.hireTimestamp||0).toLocaleDateString(),[this.translate("labels_time_since_hire")]:t+" "+this.translate("days"),[this.translate("labels_warnings")]:`${e.warnings}/3`,[this.translate("labels_tester")]:`${e.rank>=6||e.tester?this.translate("yes"):this.translate("no")}`,metadata:{buttons:e.onlineId===n?[]:[{icon:"priority_high",label:this.translate("sanction_do"),color:"red",buttonId:`sanction_up_${e.id}_${e.onlineId||-1}`,disabled:e.onlineId===n,wide:!0},{icon:"keyboard_double_arrow_down",label:this.translate("sanction_undo"),color:"green",wide:!0,buttonId:`sanction_down_${e.id}_${e.onlineId||-1}`,disabled:e.onlineId===n||0===e.warnings}]}}}))}}],buttons:[{title:this.translate("confirm")}]})}))))}onRequestManagePrivileges(e=!1,t){const n=null!=t?t:source,i=this.getPlayerFactionWhoTheyAreLeaderFor(n);i&&setImmediate((()=>v(this,void 0,void 0,(function*(){TriggerClientEvent(`${GetCurrentResourceName()}:${e?"update-dialog":"show-dialog"}`,n,{width:370,title:this.translate("manage_members"),content:this.translate("manage_members_description"),dialogId:"faction-member-privileges",dialogComponents:[{type:"stats",metadata:{items:(yield this.getAllFactionMembersAsync(i.internalId,!0)).sort(((e,t)=>e.rank>t.rank?-1:1)).map((e=>{const t=Math.round(Math.abs((Date.now()-e.hireTimestamp)/864e5));return{title:e.name+(e.onlineId===n?` (${this.translate("you")})`:""),rank:`${i.rankNames[e.rank]||"Unnamed rank"} (${e.rank})`,[this.translate("labels_hire_date")]:new Date(e.hireTimestamp||0).toLocaleDateString(),[this.translate("labels_time_since_hire")]:t+" "+this.translate("days"),[this.translate("labels_warnings")]:`${e.warnings}/3`,[this.translate("labels_tester")]:`${e.rank>=6||e.tester?this.translate("yes"):this.translate("no")}`,metadata:{buttons:e.onlineId===n?[]:[{icon:"keyboard_double_arrow_up",label:this.translate("rank_up"),color:"green",buttonId:`rank_up_${e.id}_${e.onlineId||-1}`,disabled:e.rank>=6},{icon:"keyboard_double_arrow_down",label:this.translate("rank_down"),color:"red",wide:!0,buttonId:`rank_down_${e.id}_${e.onlineId||-1}`,disabled:e.rank<=1},{icon:"star",label:this.translate("labels_tester"),color:"blue",buttonId:`make_tester_${e.id}_${e.onlineId||-1}`,disabled:e.rank<=1||e.rank>=6}]}}}))}}],buttons:[{title:this.translate("confirm")}]})}))))}onConfirmCallTow(){const e=source,t=this.getPlayerFactionWhoTheyAreLeaderFor(e);if(!t)return;const n=global.exports[`factions-${t.internalId}`].getAbandonedVehiclesNetworkIds();TriggerClientEvent(`${GetCurrentResourceName()}:show-dialog`,e,{title:this.translate("title_call_tow"),content:this.translate("title_call_tow_success"),dialogId:"blank",buttons:[{title:this.translate("confirm")}]}),emit("factions-tcc:add-to-pending-tow-calls",...n.map((e=>({vehicleNetworkId:e,originalX:t.entranceX,originalY:t.entranceY,originalZ:t.entranceZ,range:t.towRange||100}))))}onRequestCallTow(){const e=source;this.getPlayerFactionWhoTheyAreLeaderFor(e)&&TriggerClientEvent(`${GetCurrentResourceName()}:show-dialog`,e,{title:this.translate("title_call_tow"),content:this.translate("title_call_tow_confirmation",{price:(1e3,1e3.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","))}),dialogId:"faction-confirm-call-tow",buttons:[{title:this.translate("confirm")}]})}onPlayerDisconnect(){const e=source;this.entities.forEach((t=>{const n=t.members.find((t=>t.onlineId===e));n&&(n.onlineId=null)})),this.onlinePlayersWithFactions.has(e)&&(this.factionsWithOnlinePlayers.get(this.onlinePlayersWithFactions.get(e)),this.factionsWithOnlinePlayers.set(this.onlinePlayersWithFactions.get(e),this.factionsWithOnlinePlayers.get(this.onlinePlayersWithFactions.get(e)).filter((t=>t!==e))),this.onlinePlayersWithFactions.delete(e)),this.leadersManagingRanks.has(e)&&this.leadersManagingRanks.delete(e),this.leadersSanctioningPlayers.has(e)&&this.leadersSanctioningPlayers.delete(e),this.leadersManagingTesterStatuses.has(e)&&this.leadersManagingTesterStatuses.delete(e)}onPlayerAuthenticate(e,t){this.entities.forEach((n=>{const i=n.members.find((e=>e.id===t.id));if(i)return i.onlineId=e,i.onlineName=t.name,this.onlinePlayersWithFactions.set(e,n.internalId),void this.factionsWithOnlinePlayers.set(n.internalId,[...this.factionsWithOnlinePlayers.get(n.internalId)||[],e])}))}enterFaction(e){const t=this.getClosestEntityOfSameTypeEntranceToPlayer(e);t?(SetEntityCoords(GetPlayerPed(e),t.exitX,t.exitY,t.exitZ,!0,!1,!1,!0),this.setPlayerVirtualWorld(e,t.id)):global.exports.chat.addMessage(e,"Couldn't find a valid faction entrance.")}exitFaction(e){const t=this.getClosestEntityOfSameTypeExitToPlayer(e);null!=t?(SetEntityCoords(GetPlayerPed(e),t.entranceX,t.entranceY,t.entranceZ,!0,!1,!1,!0),SetEntityRoutingBucket(GetPlayerPed(e),0)):global.exports.chat.addMessage(e,"Couldn't find a valid faction exit.")}setFactionRankName(e,t){const n=t[0],i=Number(t[1]),a=t.slice(2).join(" ");if(console.log(n,",",i,",",a),!n||!i||!a.length)return void global.exports.chat.addMessage(e,"Syntax: /setfactionrankname <factionInternalId> <rankNumber> <rankName>");const r=this.getEntities().find((e=>e.internalId===n));r?(r.rankNames[i]=a,this.saveDBEntityAsync(r.id),global.exports.chat.addMessage(e,`You have successfully changed the name of rank ${i} to ${a} for faction ${n}.`)):global.exports.chat.addMessage(e,"Invalid faction.")}removeFaction(e,t){let n=this.getClosestEntityOfSameTypeToPlayer(e);t&&t[0]&&(n=this.getEntityByDBId(Number(t[0]))||this.getClosestEntityOfSameTypeToPlayer(e)),n?(console.log(global.exports.authentication.getPlayerInfo(e,"name"),"removed a faction!"),this.removeEntity(n)):console.log("Failed - Faction undefined")}createFaction(e,t){if(t.length<3)return void console.log("Syntax: /createfaction <factionId> <factionName>!");const n=t[0],i=t.slice(1).join(" "),a=GetEntityCoords(GetPlayerPed(e),!0);this.createEntity({id:-1,name:i,internalId:n,blipId:-1,entranceX:a[0],entranceY:a[1],entranceZ:a[2],exitX:0,exitY:0,exitZ:0,members:[],towRange:100,rankNames:{1:"Unnamed rank",2:"Unnamed rank",3:"Unnamed rank",4:"Unnamed rank",5:"Unnamed rank",6:"Unnamed rank"}})}factionMenu(e){const t=e;if(!this.onlinePlayersWithFactions.has(t))return;const n=this.entities.find((e=>e.internalId===this.onlinePlayersWithFactions.get(t)));n?setImmediate((()=>v(this,void 0,void 0,(function*(){TriggerClientEvent(`${GetCurrentResourceName()}:force-showui`,t,{stats:(yield this.getAllFactionMembersAsync(this.onlinePlayersWithFactions.get(t),!0)).sort(((e,t)=>e.rank>t.rank?-1:1)).map((e=>({key:e.name,value:`${n.rankNames[e.rank]} (${e.rank})`,buttons:[{color:"blue",icon:"edit",buttonId:`faction_menu_edit_${e.id}`},...e.onlineId!==t?[{color:"yellow",icon:"priority_high",buttonId:`faction_menu_warn_${e.id}`}]:[],...e.onlineId!==t?[{color:"red",icon:"logout",buttonId:`faction_menu_kick_${e.id}`}]:[]],metadata:{onlineStatus:e.onlineId>=0?"online":"offline"}}))),items:n.members.map((e=>({outline:"#404158",topLeft:"1",bottomRight:"",width:65,image:"1"}))),leftMenu:{description:this.translate("faction_management"),buttons:[{title:this.translate("motd_long"),subtitle:this.translate("motd_description"),icon:"campaign"},{title:this.translate("meeting_schedule"),subtitle:this.translate("meeting_schedule_description"),icon:"groups"},{title:this.translate("request_tow"),subtitle:this.translate("request_tow_description"),icon:"rv_hookup"},{title:this.translate("salaries_pay"),subtitle:this.translate("salaries_pay_description"),icon:"attach_money"}]},rightMenu:{description:this.translate("individual_member_management"),buttons:[{title:this.translate("privileges_manage"),subtitle:this.translate("privileges_manage_description"),icon:"star_rate"},{title:this.translate("sanctions_manage"),subtitle:this.translate("sanctions_manage_description"),icon:"report"},{title:this.translate("work_report_check"),subtitle:this.translate("work_report_check_description"),icon:"shield"}]},title:this.translate("faction_menu_title",{name:n.name,memberCount:n.members.length.toString()}),resource:GetCurrentResourceName(),isWide:!0,bottomSide:"news",news:yield global.exports["factions-logs"].getFactionLogs(n.internalId)})})))):console.log("Failed to show factionmenu to ",GetPlayerName(t))}getOnlineFactionMembers(e){const t=this.entities.find((t=>t.internalId===e));return t?t.members.filter((e=>null!=e.onlineId)):[]}getAllFactionMembersAsync(e,t=!1){return v(this,void 0,void 0,(function*(){const n=this.entities.find((t=>t.internalId===e)),i=(null==n?void 0:n.members)||[];if(t){const e=yield Promise.all(i.map((e=>v(this,void 0,void 0,(function*(){var t;return Object.assign(Object.assign({},e),{name:e.onlineName||(null===(t=yield global.exports.authentication.getOfflinePlayerInfo(e.id,"name"))||void 0===t?void 0:t.name)||"Undefined"})})))));return n.members=n.members.map((t=>{if(t.onlineName)return t;const n=e.find((e=>e.id===t.id));return n&&n.name?Object.assign(Object.assign({},t),{name:n.name,onlineName:n.name}):t})),e}return i}))}getFaction(e){return this.entities.find((t=>t.internalId===e))}isPlayerMemberOfFaction(e,t,n){var i;return null===(i=this.getFaction(e))||void 0===i?void 0:i.members.some((e=>-1!==n&&e.id===n||e.onlineId===t))}getFactionMemberRank(e,t){var n,i;return Number(null===(i=null===(n=this.getFaction(e))||void 0===n?void 0:n.members.find((e=>e.onlineId===t)))||void 0===i?void 0:i.rank)}getPlayerFactionWhoTheyAreLeaderFor(e){if(this.onlinePlayersWithFactions.has(e)){const t=this.onlinePlayersWithFactions.get(e),n=this.getEntities().find((e=>e.internalId===t));if(this.isPlayerMemberOfFaction(t,e)&&this.getFactionMemberRank(t,e)>=6)return n}return null}};b([s({eventName:`${GetCurrentResourceName()}:confirm-kick-faction-member`})],k.prototype,"onConfirmKickMember",null),b([s({eventName:`${GetCurrentResourceName()}:request-kick-faction-member`})],k.prototype,"onRequestKickMember",null),b([s({eventName:`${GetCurrentResourceName()}:confirm-warn-faction-member`})],k.prototype,"onConfirmWarnMember",null),b([s({eventName:`${GetCurrentResourceName()}:request-warn-faction-member`})],k.prototype,"onRequestWarnMember",null),b([s({eventName:`${GetCurrentResourceName()}:confirm-modify-tester-status`})],k.prototype,"onConfirmModifyTesterStatus",null),b([s({eventName:`${GetCurrentResourceName()}:request-modify-tester-status`})],k.prototype,"onRequestModifyTesterStatus",null),b([s({eventName:`${GetCurrentResourceName()}:confirm-increment-rank`})],k.prototype,"onConfirmIncrementRank",null),b([s({eventName:`${GetCurrentResourceName()}:request-increment-rank`})],k.prototype,"onRequestIncrementRank",null),b([s({eventName:`${GetCurrentResourceName()}:request-manage-activity`})],k.prototype,"onRequestManageActivity",null),b([s({eventName:`${GetCurrentResourceName()}:request-manage-sanctions`})],k.prototype,"onRequestManageSanctions",null),b([s({eventName:`${GetCurrentResourceName()}:request-manage-privileges`})],k.prototype,"onRequestManagePrivileges",null),b([s({eventName:`${GetCurrentResourceName()}:confirm-call-tow`})],k.prototype,"onConfirmCallTow",null),b([s({eventName:`${GetCurrentResourceName()}:request-call-tow`})],k.prototype,"onRequestCallTow",null),b([s()],k.prototype,"onPlayerDisconnect",null),b([s()],k.prototype,"onPlayerAuthenticate",null),b([l()],k.prototype,"enterFaction",null),b([l()],k.prototype,"exitFaction",null),b([l(6)],k.prototype,"setFactionRankName",null),b([l(6)],k.prototype,"removeFaction",null),b([l(6)],k.prototype,"createFaction",null),b([l()],k.prototype,"factionMenu",null),b([o()],k.prototype,"getOnlineFactionMembers",null),b([o()],k.prototype,"getAllFactionMembersAsync",null),b([o()],k.prototype,"getFaction",null),b([o()],k.prototype,"isPlayerMemberOfFaction",null),b([o()],k.prototype,"getFactionMemberRank",null),b([o()],k.prototype,"getPlayerFactionWhoTheyAreLeaderFor",null),k=b([r({translationFile:{en:{activity_manage:"Manage Activity",activity_manage_description:"Here you can view your members' registered activity: latest activity date, activity points, etc.",activity_type_other:"other_activities",activity_type_ticket:"tickets_given",activity_type_arrest:"citizens_arrested",confirm:"Confirm",days:"Days",faction_management:"Faction Management",faction_menu_title:"Faction Menu - {name} ({memberCount} Members)",in_city:"In city",individual_member_management:"Individual Member Management",labels_hire_date:"hire_date",labels_time_since_hire:"time_since_hire",labels_tester:"tester",labels_warnings:"warnings",manage_members:"Manage Members",manage_members_description:"Here you can manage your members: view their details, rank them up/down, or give/take them the privilege of being a tester.",meeting_schedule:"Schedule Meeting",meeting_schedule_description:"Schedule a meeting with all members",motd_description:"Change the MOTD of the faction",motd_long:"Message Of The Day",no:"No",not_in_city:"Not in city",points:"Points",privileges_manage:"Manage Privileges",privileges_manage_description:"Rank up/down, make tester, etc.",rank_down:"Rank down",rank_up:"Rank up",request_tow:"Request tow",request_tow_description:"Request your vehicles to be towed back",salaries_pay:"Pay Salaries",salaries_pay_description:"Pay all salaries immediately",sanction_do:"Sanction",sanction_undo:"Remove Sanction",sanctions_manage:"Manage Sanctions",sanctions_manage_description:"View, Add or Remove sanctions.",seniority:"Seniority",title_call_tow:"Call for tow",title_call_tow_confirmation:"Are you sure you want to call the Tow Car Company to retrieve your faction's vehicles? This will cost you ${price}.",title_call_tow_success:"The Tow Car Company has been successfully contacted, and your vehicles will be towed back to your faction as soon as possible.",title_member_rank_down:"Member Rank Down",title_member_rank_down_confirmation:"Are you sure you want to lower the rank of this member? They will lose some privileges inside the faction.",title_member_rank_up:"Member Rank Up",title_member_rank_up_confirmation:"Are you sure you want to raise the rank of this member? By doing this, they will gain privileges inside the faction.",title_member_warn:"Member sanction",title_member_warn_confirmation:"Are you sure you want to sanction this player? Keep in mind that if they reach 3/3 sanctions, they will be kicked out of the faction.",title_member_unwarn:"Member remove sanction",title_member_unwarn_confirmation:"Are you sure you want to remove one of this player's sanctions?",title_member_kick:"Member kick",title_member_kick_confirmation:"Are you sure you want to kick this player out of the faction? They will no longer have any access or privilege to it.",title_member_tester_make:"Member make tester",title_member_tester_make_confirmation:"Are you sure you want to make this player a tester? They will then have access to certain privileges which will allow them to test people before entering the faction.",title_member_tester_unmake:"Member revoke tester",title_member_tester_unmake_confirmation:"Are you sure you want to revoke this member's tester status? They will no longer have access to people testing privileges.",work_report_check:"Check Work Report",work_report_check_description:"Check Member's Work Report.",yes:"Yes",you:"You"},ro:{activity_manage:"Manageriere rapoarte",activity_manage_description:"Aici poti verifica activitatea fiecarui membru al factiunii: ultima data a raportului, numarul de puncte de raport, etc.",activity_type_other:"alte_rapoarte",activity_type_ticket:"amenzi_acordate",activity_type_arrest:"cetateni_arestati",confirm:"Confirma",days:"Luni",faction_management:"Managerierea factiunii",faction_menu_title:"Meniul Factiunii - {name} ({memberCount} Membri)",in_city:"In oras",individual_member_management:"Managerierea membrilor",labels_hire_date:"data_intrarii",labels_time_since_hire:"timp_in_factiune",labels_tester:"tester",labels_warnings:"sanctiuni",manage_members:"Manageriere membri",manage_members_description:"Aici iti poti manageria membrii factiunii: le poti verifica detaliile, schimba rank-ul, sau le poti acorda/scoate privilegiul de a fi tester.",meeting_schedule:"Programeaza sedinta",meeting_schedule_description:"Programeaza o sedinta cu toti membrii",motd_description:"Schimba mesajul zilei",motd_long:"Mesajul zilei",no:"Nu",not_in_city:"Plecat",points:"Puncte",privileges_manage:"Modifica privilegii",privileges_manage_description:"Rank up/down, statut tester, etc.",rank_down:"Rank down",rank_up:"Rank up",request_tow:"Contact TCC",request_tow_description:"Cere tractarea vehiculelor factiunii",salaries_pay:"Acorda salarii",salaries_pay_description:"Acorda salariile imediat",sanction_do:"Sanctioneaza",sanction_undo:"Scoate sanctiune",sanctions_manage:"Modifica sanctiuni",sanctions_manage_description:"Vezi, adauga sau sterge sanctiuni.",seniority:"Vechime",title_call_tow:"Apel TCC",title_call_tow_confirmation:"Esti sigur ca doresti sa faci un apel la factiunea Tow Car Company pentru recuperarea vehiculelor factiunii? Acest lucru te va costa ${price} in total.",title_call_tow_success:"Factiunea Tow Car Company a fost contactata cu succes, iar vehiculele factiunii tale vor fi aduse inapoi in cel mai scurt timp.",title_member_rank_down:"Acorzi rank down",title_member_rank_down_confirmation:"Esti sigur ca vrei sa ii scazi rank-ul acestui membru? Va pierde privilegii in cadrul factiunii.",title_member_rank_up:"Acorzi rank up",title_member_rank_up_confirmation:"Esti sigur ca vrei sa cresti rank-ul acestui membru? Facand asta, acesta va avea privilegii aditionale in cadrul factiunii.",title_member_warn:"Acorzi sanctiune",title_member_warn_confirmation:"Esti sigur ca doresti sa ii aplici o sanctiune acestui membru? Daca ajunge la 3/3 sanctiuni, va fi dat afara din factiune.",title_member_unwarn:"Scoti sanctiune",title_member_unwarn_confirmation:"Esti sigur ca doresti sa scoti o sanctiune a acestui membru?",title_member_kick:"Da afara un membru",title_member_kick_confirmation:"Esti sigur ca doresti sa dai afara acest membru? Acesta nu va mai face parte din factiune, si nu va mai avea niciun privilegiu fata de aceasta.",title_member_tester_make:"Acorzi statut de tester",title_member_tester_make_confirmation:"Esti sigur ca doresti sa ii acorzi acestui membru statutul de tester? Facand asta, membrul va avea acces la privilegii de testare a oamenilor ce doresc sa intre in factiune.",title_member_tester_unmake:"Scoti statutul de tester",title_member_tester_unmake_confirmation:"Esti sigur ca doresti sa ii revoci statutul de tester acestui membru? Facand asta, membrul nu va mai avea acces la privilegii de testare a oamenilor ce doresc sa intre in factiune.",work_report_check:"Raport membri",work_report_check_description:"Verifica rapoartele membrilor",yes:"Da",you:"Tu"}}})],k),new k("factions",!0),console.warn("[factions server.controller.ts]: The getAllFactionMembersAsync call needs to be revisited, as it does a little too many requests.")})();