(()=>{"use strict";var e=function(e,t,i,n){return new(i||(i=Promise))((function(s,r){function o(e){try{c(n.next(e))}catch(e){r(e)}}function a(e){try{c(n.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};new class extends class extends class extends class extends class{constructor(){this.routingBucketCondition=(e,t)=>!0,this.assignServerBaseListeners()}RegisterAdminCommand(e,t,i,n){RegisterCommand(e,((e,n,s)=>{Number(global.exports.authentication.getPlayerInfo(e,"adminLevel"))<t||i(e,n,s)}),n)}assignServerBaseListeners(){onNet(`${GetCurrentResourceName()}:set-client-routing-bucket`,((e,t)=>{this.routingBucketCondition(e,t)&&SetEntityRoutingBucket(e,t)}))}}{removeClientsideVehicles(){TriggerClientEvent(`${GetCurrentResourceName()}:ARM_remove-vehicles`,-1)}}{}{constructor(e){super(),this.dbTableName=e,this._entities=[],this.loadDBEntities(),this._assignExports(),this.assignDBEntityCommunicationListeners()}get entities(){return this._entities}getEntities(){return this._entities}createEntity(t){return(()=>e(this,void 0,void 0,(function*(){try{const e=this.getEntityProperties(t),i=this.getEntityPropertiesValues(t,e),n=yield global.exports.oxmysql.insert_async(`INSERT INTO \`${this.dbTableName}\` (${e.join(", ")}) VALUES (${Array(e.length).fill("?").join(", ")})`,i);return this._entities.push(Object.assign(Object.assign({},t),{id:n})),this.syncWithClients(),n}catch(e){return console.log(e),null}})))()}removeEntity(t){return(()=>e(this,void 0,void 0,(function*(){try{const e=yield global.exports.oxmysql.query_async(`DELETE FROM \`${this.dbTableName}\` WHERE id = ?`,[t.id]);return this._entities=this._entities.filter((e=>e.id!==t.id)),this.syncWithClients(),!!e}catch(e){return console.log(e),!1}})))()}saveDBEntityAsync(t){return(()=>e(this,void 0,void 0,(function*(){try{const e=this.getEntityByDBId(t),i=this.getEntityProperties(e),n=this.getEntityPropertiesValues(e,i),s=" = ?, ",r=yield global.exports.oxmysql.update_async(`UPDATE \`${this.dbTableName}\` SET ${i.join(s).concat(s).slice(0,-2)} WHERE id = ?`,[...n,e.id]);return r&&this.syncWithClients(),r>0}catch(e){return console.log(e),!1}})))()}getEntityByDBId(e){return this._entities.find((t=>t.id===e))}loadDBEntities(){setImmediate((()=>e(this,void 0,void 0,(function*(){const e=(yield global.exports.oxmysql.query_async(`SELECT * FROM \`${this.dbTableName}\``,[])).map((e=>(Object.keys(e).forEach((t=>{var i;e[t]=JSON.parse((i=e[t].toString(),!/^\s*$/.test(i)&&(i=(i=(i=i.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@")).replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]")).replace(/(?:^|:|,)(?:\s*\[)+/g,""),/^[\],:{}\s]*$/.test(i))?e[t]:`"${e[t]}"`),(function(e,t){return"object"==typeof t||isNaN(t)?t:Number(t)}))})),e)));(null==e?void 0:e.length)&&(this._entities=e,setTimeout((()=>{this.syncWithClients()}),2e3))}))))}getEntityProperties(e){const t=[];for(let i in e)"id"!==i&&t.push(i);return t}assignDBEntityCommunicationListeners(){onNet("authentication:player-authenticated",(e=>{this._entities.length&&this.syncWithClients(e)}))}getEntityPropertiesValues(e,t){return t.map((t=>Array.isArray(e[t])?JSON.stringify(e[t]):e[t].toString()))}syncWithClients(e){TriggerClientEvent(`${GetCurrentResourceName()}:db-send-entities`,e||-1,this.entities)}_assignExports(){exports("getEntities",this.getEntities.bind(this))}}{constructor(e){super(e),this.phones=new Map,this.registerListeners()}registerListeners(){onNet(`${GetCurrentResourceName()}:add-contact`,(e=>{const t=this.entities.find((e=>e.id===Number(global.exports.authentication.getPlayerInfo(source,"phone"))));t&&(t.contacts.push(e),this.saveDBEntityAsync(t.id))})),onNet(`${GetCurrentResourceName()}:request-use-phone`,(()=>{const e=[...global.exports.factions.getOnlineFactionMembers("taxi").map((e=>({name:GetPlayerName(e.onlineId),phone:global.exports.authentication.getPlayerInfo(e.onlineId,"phone").toString(),service:"taxi"})))],t=Object.assign(Object.assign({},this.entities.find((e=>e.id===Number(global.exports.authentication.getPlayerInfo(source,"phone"))))),{serviceAgents:e});TriggerClientEvent(`${GetCurrentResourceName()}:force-showui`,source,t)})),onNet(`${GetCurrentResourceName()}:request-service-call`,(e=>{e.phone?this.executeCall(e):e.service})),onNet("authentication:player-authenticated",((e,t)=>{this.phones.set(t.phone,e)})),onNet("playerDropped",(()=>{const e=Array.from(this.phones.keys()).find((e=>this.phones[e]===source));e&&this.phones.delete(e)}))}executeCall(e){this.phones[e.phone]&&TriggerClientEvent(`${GetCurrentResourceName()}:execute-call`,source,e)}}("phone_contacts")})();