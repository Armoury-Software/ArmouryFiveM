(()=>{"use strict";const e=(e,i,n,s,r,o,a)=>t([e,i,n,s,r,o])<=a,t=e=>{var t=e[3]-e[0],i=e[4]-e[1],n=e[5]-e[2];return Math.hypot(t,i,n)},i=e=>e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),n=e=>!/^\s*$/.test(e)&&(e=(e=(e=e.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@")).replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]")).replace(/(?:^|:|,)(?:\s*\[)+/g,""),/^[\],:{}\s]*$/.test(e)),s={onAccountAuthenticate:"authentication:account-success",onPlayerConnect:"playerJoining",onPlayerDeath:"armoury:onPlayerDeath",onPlayerAuthenticate:"authentication:player-authenticated",onPlayerDisconnect:"playerDropped",onResourceStop:"onResourceStop",onContextMenuItemPressed:"armoury-overlay:context-menu-item-pressed",onPlayerEnterVehicle:"armoury:onPlayerEnterVehicle",onPlayerExitVehicle:"armoury:onPlayerExitVehicle",onPlayerClientsidedCacheLoaded:"armoury:player-resource-cache-loaded",onPlayerStartTowVehicle:"armoury:onPlayerStartTowVehicle",onPlayerStopTowVehicle:"armoury:onPlayerStopTowVehicle"};var r;!function(e){e[e.SERVER_TO_SERVER=0]="SERVER_TO_SERVER",e[e.SERVER_TO_CLIENT=1]="SERVER_TO_CLIENT",e[e.CLIENT_TO_SERVER=2]="CLIENT_TO_SERVER",e[e.CLIENT_TO_CLIENT=3]="CLIENT_TO_CLIENT"}(r||(r={}));const o=new Map,a=new Map,l=new Map;function u(e){return function(t){return class extends t{constructor(...i){super(...i),this.translationFile=null==e?void 0:e.translationFile,o.has(t)&&o.get(t).forEach((([e,t,i])=>{i===r.CLIENT_TO_CLIENT?on(t,super[e].bind(this)):onNet(t,super[e].bind(this))})),a.has(t)&&a.get(t).forEach((e=>{exports(e,super[e].bind(this))})),l.has(t)&&l.get(t).forEach((([e,t])=>{IsDuplicityVersion()?RegisterCommand(((null==t?void 0:t.isKeyBinding)?"+":"")+e.toLowerCase()+((null==t?void 0:t.suffix)||""),((i,n,s)=>{(null==t?void 0:t.adminLevelRequired)&&Number(global.exports.authentication.getPlayerInfo(i,"adminLevel"))<(null==t?void 0:t.adminLevelRequired)||super[e].call(this,i,n,s)}),!1):RegisterCommand(((null==t?void 0:t.isKeyBinding)?"+":"")+e.toLowerCase()+((null==t?void 0:t.suffix)||""),((t,i,n)=>{super[e].call(this,i,n)}),!1)}))}}}}function c(e){return function(t,i,n){const a=s[i]||(null==e?void 0:e.eventName),l=(null==e?void 0:e.direction)||r.CLIENT_TO_SERVER;(null==a?void 0:a.length)?(o.has(t.constructor)||o.set(t.constructor,[]),o.get(t.constructor).some((([e,t,n])=>e===i))||o.get(t.constructor).push([i,a,l])):console.error(`${i} is not recognized as a default event, thus this listener won't work. Please use the eventName property inside the data parameter.`)}}var d=function(e,t,i,n){var s,r=arguments.length,o=r<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(r<3?s(o):r>3?s(t,i,o):s(t,i))||o);return r>3&&o&&Object.defineProperty(t,i,o),o};let y=class extends class{constructor(){this.routingBucketCondition=(e,t)=>!0,this.assignServerBaseListeners()}RegisterAdminCommand(e,t,i,n){RegisterCommand(e,((e,n,s)=>{Number(global.exports.authentication.getPlayerInfo(e,"adminLevel"))<t||i(e,n,s)}),n)}assignServerBaseListeners(){onNet(`${GetCurrentResourceName()}:set-client-routing-bucket`,((e,t)=>{this.routingBucketCondition(e,t)&&SetEntityRoutingBucket(e,t)}))}setRoutingBucket(e,t){SetEntityRoutingBucket(GetPlayerPed(e),t),TriggerClientEvent(`${GetCurrentResourceName()}:set-routing-bucket`,e,t)}}{constructor(){super(...arguments),this._virtualWorldsWithPlayers=new Map}get virtualWorldsWithPlayers(){return this._virtualWorldsWithPlayers}onPlayerEnteredScope(e){TriggerClientEvent(`${GetCurrentResourceName()}:refresh-virtual-world`,e.for)}setPlayerVirtualWorld(e,t){const i=this.getPlayerVirtualWorld(e);isNaN(i)||this._virtualWorldsWithPlayers.set(i,(this._virtualWorldsWithPlayers.has(i)?this._virtualWorldsWithPlayers.get(i):[]).filter((t=>t!==e)));const n=[...this._virtualWorldsWithPlayers.has(t)?this._virtualWorldsWithPlayers.get(t):[],e];this._virtualWorldsWithPlayers.set(t,n),global.exports.authentication.setPlayerInfo(e,"virtualWorld",t)}getPlayerVirtualWorld(e){return Math.max(0,Number(global.exports.authentication.getPlayerInfo(e,"virtualWorld")))}removeClientsideVehicles(){TriggerClientEvent(`${GetCurrentResourceName()}:ARM_remove-vehicles`,-1)}};d([c({eventName:"playerEnteredScope"})],y.prototype,"onPlayerEnteredScope",null),y=d([u()],y);var h=function(e,t,i,n){var s,r=arguments.length,o=r<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(r<3?s(o):r>3?s(t,i,o):s(t,i))||o);return r>3&&o&&Object.defineProperty(t,i,o),o};let p=class extends y{constructor(){super(...arguments),this._translationLanguage="en",this._clientsidedResourceMap=new Map}get translationLanguage(){return this._translationLanguage}get clientsidedResourceMap(){return this._clientsidedResourceMap}getPlayerClientsidedCacheKey(e,t){if(this._clientsidedResourceMap.has(e)){const i=this._clientsidedResourceMap.get(e);if(i[t])return i[t]}return null}updatePlayerClientsidedCacheKey(e,t,i){const n=this._clientsidedResourceMap.has(e)&&this._clientsidedResourceMap.get(e)||{};n[t]=i,this._clientsidedResourceMap.set(e,n),TriggerClientEvent("armoury-overlay:update-resource-metadata",e,GetCurrentResourceName(),t,i)}onPlayerClientsidedCacheLoaded(e){e[GetCurrentResourceName()]&&this._clientsidedResourceMap.set(source,e[GetCurrentResourceName()])}onPlayerDisconnect(){this._clientsidedResourceMap.has(source)&&this._clientsidedResourceMap.delete(source)}translate(e,t){let i=this.translationFile[this._translationLanguage][e];return t&&Object.keys(t).forEach((e=>{i=i.replace(`{${e}}`,t[e])})),i}setTranslationLanguage(e){this._translationLanguage=e}};h([c()],p.prototype,"onPlayerClientsidedCacheLoaded",null),h([c()],p.prototype,"onPlayerDisconnect",null),p=h([u()],p);var g=function(e,t,i,n){var s,r=arguments.length,o=r<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(r<3?s(o):r>3?s(t,i,o):s(t,i))||o);return r>3&&o&&Object.defineProperty(t,i,o),o},m=function(e,t,i,n){return new(i||(i=Promise))((function(s,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function a(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}l((n=n.apply(e,t||[])).next())}))};let E=class extends p{constructor(e,t=!1){super(),this.dbTableName=e,this._entities=[],this._cachedProperties=[],this._playerToEntityBindings=new Map,this.computeTableProperties(),t&&this.loadDBEntities()}get entities(){return this._entities}get cachedProperties(){return this._cachedProperties}get playerToEntityBindings(){return this._playerToEntityBindings}getEntities(){return this._entities}createEntity(e,t){return(()=>m(this,void 0,void 0,(function*(){try{let i=this.getEntityProperties(e),n=this.getEntityPropertiesValues(e,i);t&&(i=["id",...i],n=[t.toString(),...n]);const s=yield global.exports.oxmysql.insert_async(`INSERT INTO \`${this.dbTableName}\` (${i.join(", ")}) VALUES (${Array(i.length).fill("?").join(", ")})`,n),r=Object.assign(Object.assign({},e),{id:t||s});return this._entities.push(r),this.syncWithClients(),r}catch(e){return console.log(e),null}})))()}removeEntity(e){return(()=>m(this,void 0,void 0,(function*(){try{const t=yield global.exports.oxmysql.query_async(`DELETE FROM \`${this.dbTableName}\` WHERE id = ?`,[e.id]);return this._entities=this._entities.filter((t=>t.id!==e.id)),this.syncWithClients(),!!t}catch(e){return console.log(e),!1}})))()}saveDBEntityAsync(e){return(()=>m(this,void 0,void 0,(function*(){try{const t=this.getEntityByDBId(e),i=this.getEntityProperties(t),n=this.getEntityPropertiesValues(t,i),s=" = ?, ",r=yield global.exports.oxmysql.update_async(`UPDATE \`${this.dbTableName}\` SET ${i.join(s).concat(s).slice(0,-2)} WHERE id = ?`,[...n,t.id]);return r&&this.syncWithClients(),r>0}catch(e){return console.log(e),!1}})))()}getEntityByDBId(e){return this._entities.find((t=>t.id===e))}loadDBEntityFor(e,t="id",i){return m(this,void 0,void 0,(function*(){const s=(yield global.exports.oxmysql.query_async(`SELECT * FROM \`${this.dbTableName}\` WHERE ${t} = ?`,[e])).map((e=>(Object.keys(e).forEach((t=>{e[t]=JSON.parse(n(e[t].toString())?e[t]:`"${e[t]}"`,(function(e,t){return"object"==typeof t||isNaN(t)?t:Number(t)}))})),e)));return(null==s?void 0:s.length)?(s.forEach((e=>{this._entities.push(e),i&&this.bindEntityToPlayerByEntityId(e.id,i)})),setTimeout((()=>{this.syncWithClients()}),2e3),(null==s?void 0:s.length)>1?s:s[0]):null}))}loadDBEntities(){return m(this,void 0,void 0,(function*(){const e=(yield global.exports.oxmysql.query_async(`SELECT * FROM \`${this.dbTableName}\``,[])).map((e=>(Object.keys(e).forEach((t=>{e[t]=JSON.parse(n(e[t].toString())?e[t]:`"${e[t]}"`,(function(e,t){return"object"==typeof t||isNaN(t)?t:Number(t)}))})),e)));return(null==e?void 0:e.length)&&(this._entities=e,setTimeout((()=>{this.syncWithClients()}),2e3)),this._entities}))}getEntityProperties(e){const t=[];for(let i in e)"id"===i||this._cachedProperties.length&&!this._cachedProperties.includes(i)||t.push(i);return t}getEntityPropertiesValues(e,t){return t.map((t=>Array.isArray(e[t])||"object"==typeof e[t]?JSON.stringify(e[t]):e[t].toString()))}syncWithClients(e){TriggerClientEvent(`${GetCurrentResourceName()}:db-send-entities`,e||-1,this.entities)}bindEntityToPlayer(e,t){this.entities.includes(e)&&this.bindEntityToPlayerByEntityId(e.id,t)}bindEntityToPlayerByEntityId(e,t){this._entities.some((t=>t.id===e))&&(this._playerToEntityBindings.has(t)?this._playerToEntityBindings.set(t,[...this._playerToEntityBindings.get(t),e]):this._playerToEntityBindings.set(t,[e]))}onBoundEntityDestroyed(e,t){}onPlayerAuthenticate(e,t){this._entities.length&&this.syncWithClients(e)}onPlayerDisconnect(){this._playerToEntityBindings.has(source)&&((this._playerToEntityBindings.has(source)?this._playerToEntityBindings.get(source):[]).forEach((e=>{const t=this._entities.find((t=>t.id===e));t&&(this.onBoundEntityDestroyed(t,source),this._entities.splice(this._entities.indexOf(t),1))})),this._playerToEntityBindings.delete(source))}computeTableProperties(){return m(this,void 0,void 0,(function*(){const e=yield global.exports.oxmysql.query_async(`DESCRIBE ${this.dbTableName}`,[]);e?e.forEach((e=>{this._cachedProperties.push(e.Field)})):console.error(`[SQL ERROR:] computeTableProperties for ${GetCurrentResourceName()} did not work.`)}))}};g([function(e,t,i){a.has(e.constructor)||a.set(e.constructor,[]),a.get(e.constructor).some((e=>e===t))||a.get(e.constructor).push(t)}],E.prototype,"getEntities",null),g([c()],E.prototype,"onPlayerAuthenticate",null),g([c()],E.prototype,"onPlayerDisconnect",null),E=g([u()],E);class P extends E{getClosestEntityOfSameTypeToPlayer(e){return this.getClosestEntityOfSameTypeExitToPlayer(e)||this.getClosestEntityOfSameTypeEntranceToPlayer(e)}getClosestEntityOfSameTypeEntranceToPlayer(t){const i=GetEntityCoords(GetPlayerPed(t),!0);return this.entities.find((t=>e(i[0],i[1],i[2],t.entranceX,t.entranceY,t.entranceZ,3)))||null}getClosestEntityOfSameTypeExitToPlayer(t){const i=this.getPlayerVirtualWorld(t)||0,n=this.getEntityByDBId(i),s=GetEntityCoords(GetPlayerPed(t),!0);return n&&e(s[0],s[1],s[2],n.exitX,n.exitY,n.exitZ,3)?n:null}}const f=[{pos:[997.4505615234375,-3200.703369140625,-36.4007568359375],name:"Electricity Company",defaultProductPrice:500,isUnique:!0},{pos:[-77.6044,-833.7363,243.3737],name:"Phone Company",defaultProductPrice:500,isUnique:!0},{pos:[0,0,0],name:"24/7",defaultProductPrice:500}];new class extends P{constructor(e){super(e,!0),this.registerCommands(),this.registerListeners(),this.registerExports()}registerCommands(){this.RegisterAdminCommand("setdepositposition",6,((e,t)=>{let i;const n=GetEntityCoords(GetPlayerPed(e),!0);t&&t[0]?i=this.getEntityByDBId(Number(t[0])):console.log("Syntax: /setdepositposition <business-id>!"),i?(i.depositX=n[0],i.depositY=n[1],i.depositZ=n[2],console.log(global.exports.authentication.getPlayerInfo(e,"name"),`has set a new deposit position for business ID ${i.id} to X: ${i.depositX.toFixed(4)}, Y:${i.depositY.toFixed(4)}, Z:${i.depositZ.toFixed(4)}!`),this.saveDBEntityAsync(i.id)):console.log("Failed - Business undefined")}),!1),this.RegisterAdminCommand("bizid",1,(e=>{let t=this.getClosestEntityOfSameTypeToPlayer(e);t?console.log(`Closest business ID is: ${t.id}`):console.log("Failed - No business close to player.")}),!1),this.RegisterAdminCommand("removebusiness",6,((e,t)=>{let i=this.getClosestEntityOfSameTypeToPlayer(e);t&&t[0]&&(i=this.getEntityByDBId(Number(t[0]))||this.getClosestEntityOfSameTypeToPlayer(e)),i?(console.log(global.exports.authentication.getPlayerInfo(e,"name"),"removed a business!"),this.removeEntity(i)):console.log("Failed - Business undefined")}),!1),this.RegisterAdminCommand("createbusiness",6,((e,t)=>{if(t.length<3)return void console.log("Syntax: /createbusiness <business-type> <price> <level>!");const i=Number(t[0]),n=Number(t[1]),s=Number(t[2]),r=GetEntityCoords(GetPlayerPed(e),!0);f[i].isUnique&&this.entities.find((e=>e.name===f[i].name))?global.exports.chat.addMessage(e,"Because this business type is unique, there can only be one business of this type on the server."):this.createEntity({owner:"",level:s,name:f[i].name,entranceX:r[0],entranceY:r[1],entranceZ:r[2],firstPurchasePrice:n,exitX:f[i].pos[0],exitY:f[i].pos[1],exitZ:f[i].pos[2],sellingPrice:0,partnerIds:[],parent:-1,productPrice:f[i].defaultProductPrice})}),!1),RegisterCommand("enterbusiness",(e=>{const t=this.getClosestEntityOfSameTypeEntranceToPlayer(e);t?this.isEnterable(t)?t.owner===global.exports.authentication.getPlayerInfo(e,"name")||t.partnerIds.includes(Number(global.exports.authentication.getPlayerInfo(e,"id")))?this.teleportIntoBusiness(e,t):TriggerClientEvent(`${GetCurrentResourceName()}:force-showui`,e,t):emit(`${GetCurrentResourceName()}:business-interact-request`,e,t):global.exports.chat.addMessage(e,"Couldn't find a valid business.")}),!1),RegisterCommand("exitbusiness",(e=>{let t=this.getClosestEntityOfSameTypeExitToPlayer(e);t&&(SetEntityCoords(GetPlayerPed(e),t.entranceX,t.entranceY,t.entranceZ,!0,!1,!1,!0),SetEntityRoutingBucket(GetPlayerPed(e),0))}),!1),RegisterCommand("businessmenu",(e=>{var t;const n=GetEntityRoutingBucket(GetPlayerPed(e)),s=this.entities.find((e=>e.id===n));0!==n&&s?TriggerClientEvent(`${GetCurrentResourceName()}-menu:force-showui`,e,{stats:[{key:"Level",value:s.level},{key:"Partners",value:null===(t=s.partnerIds)||void 0===t?void 0:t.length},{key:"Income",value:"$750/hr"},{key:"Security(%)",value:"0%"},{key:"Pet",value:"German Shepherd"},{key:"Pet Status",value:"Happy"},{key:"Price",value:s.sellingPrice>0?`$${i(s.sellingPrice)}`:"Not for Sale"},{key:"Value",value:"$"+i(s.firstPurchasePrice)},{key:"Upgrades",value:"0/3"},{key:"Taxes",value:"$1,000/hr"},{key:"Pet Expenses",value:"$50/hr"}],items:s.partnerIds.map((e=>({outline:"#404158",topLeft:"1",bottomRight:"",width:65,image:"1"}))),leftMenu:{description:"Business Management",buttons:[{title:"Set For Sale",subtitle:"Enable players to buy your business",icon:"sell"},{title:"Sell To Bank",subtitle:"Sell immediately for 50% value",icon:"account_balance"},{title:"Fire All Partners",subtitle:"Fire all partners immediately",icon:"logout"}]},rightMenu:{description:"Business Upgrades",buttons:[{title:"Heal Upgrade",subtitle:"Enable healing for $300/hr",icon:"favorite_border"}]},title:`Business Menu - ${s.owner}'s ${s.name} (#${s.id})`}):console.log("Failed to show businessmenu to ",GetPlayerName(e))}),!1)}registerListeners(){onNet(`${GetCurrentResourceName()}:request-purchase-business`,(()=>{const e=this.getClosestEntityOfSameTypeToPlayer(source);if(e.owner&&e.sellingPrice>0||!e.owner&&e.firstPurchasePrice<=Number(global.exports.authentication.getPlayerInfo(source,"cash"))){const t=e.owner?e.sellingPrice:e.firstPurchasePrice;TriggerClientEvent(`${GetCurrentResourceName()}:show-dialog`,source,{title:"Purchase this business?",content:`Are you sure you want to purchase this business for $${i(t)}?`,buttons:[{title:"Confirm"}],dialogId:"purchase_unowned_business"})}})),onNet(`${GetCurrentResourceName()}:confirm-purchase-business`,(e=>{return t=this,i=void 0,s=function*(){const t=this.getClosestEntityOfSameTypeToPlayer(e);if(t.owner&&t.sellingPrice>0||!t.owner&&t.firstPurchasePrice<=Number(global.exports.authentication.getPlayerInfo(e,"cash"))){const i=t.owner?t.sellingPrice:t.firstPurchasePrice,n=t.owner;t.owner=global.exports.authentication.getPlayerInfo(e,"name"),(yield this.saveDBEntityAsync(t.id))?(global.exports.authentication.setPlayerInfo(e,"cash",Number(global.exports.authentication.getPlayerInfo(e,"cash"))-i,!1),global.exports.authentication.setPlayerInfo(e,"businesskeys",[...global.exports.authentication.getPlayerInfo(e,"businesskeys"),t.id]),this.teleportIntoBusiness(e,t),TriggerClientEvent(`${GetCurrentResourceName()}:business-purchased`,e,t)):t.owner=n}},new((n=void 0)||(n=Promise))((function(e,r){function o(e){try{l(s.next(e))}catch(e){r(e)}}function a(e){try{l(s.throw(e))}catch(e){r(e)}}function l(t){var i;t.done?e(t.value):(i=t.value,i instanceof n?i:new n((function(e){e(i)}))).then(o,a)}l((s=s.apply(t,i||[])).next())}));var t,i,n,s}))}syncWithClients(e){if(super.syncWithClients(e),e){const t=global.exports.authentication.getPlayerInfo(e,"name"),i=this.entities.filter((e=>e.owner===t));i.length&&global.exports.authentication.setPlayerInfo(e,"businesskeys",i.map((e=>e.id)))}}isEnterable(e){return 0!==e.exitX&&0!==e.exitY&&0!==e.exitZ}teleportIntoBusiness(e,t){SetEntityCoords(GetPlayerPed(e),t.exitX,t.exitY,t.exitZ,!0,!1,!1,!0),SetEntityRoutingBucket(GetPlayerPed(e),t.id)}registerExports(){exports("getClosestBusiness",this.getClosestEntityOfSameTypeToPlayer.bind(this)),exports("getClosestBusinessExit",this.getClosestEntityOfSameTypeExitToPlayer.bind(this))}}("businesses")})();